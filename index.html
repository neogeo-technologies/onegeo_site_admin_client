<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<script>;window.isMobile=(function(a){if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))){return true;}else{return false;};})(navigator.userAgent||navigator.vendor||window.opera);</script>
		<script src="libs/jquery/dist/jquery.min.js"></script>
		<script src="libs/moment/min/moment-with-locales.min.js"></script>
		<script src="libs/bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="libs/editablegrid/editablegrid.js"></script>
		<script src="libs/editablegrid/editablegrid_renderers.js"></script>
		<script src="libs/editablegrid/editablegrid_editors.js"></script>
		<script src="libs/editablegrid/editablegrid_validators.js"></script>
		<script src="libs/editablegrid/editablegrid_utils.js"></script>
		<script src="libs/editablegrid/editablegrid_charts.js"></script>
		<script src="js/editablegrid_overloaded.js"></script>
		<script src="js/editablegrid_utils.js"></script>
		<script src="js/onegeo_client.js"></script>

		<script>
		// Simple JavaScript Templating
		// John Resig - https://johnresig.com/ - MIT Licensed
		(function(){
			var cache = {};
			this.template = function template(str, data) {
			// Figure out if we're getting a template, or if we need to
			// load the template - and be sure to cache the result.
			var fn = !/\W/.test(str) ?
				cache[str] = cache[str] ||
				template(document.getElementById(str).innerHTML) :
				// Generate a reusable function that will serve as a template
				// generator (and which will be cached).
				new Function("obj",
					"var p=[],print=function(){p.push.apply(p,arguments);};" +
					// Introduce the data as local variables using with(){}
					"with(obj){p.push('" +
					// Convert the template into pure JavaScript
					str
						.replace(/[\r\t\n]/g, " ")
						.split("{%").join("\t")
						.replace(/((^|%})[^\t]*)'/g, "$1\r")
						.replace(/\t=(.*?)%}/g, "',$1,'")
						.split("\t").join("');")
						.split("%}").join("p.push('")
						.split("\r").join("\\'")
						+ "');}return p.join('');");

					// Provide some basic currying to the user
					return data ? fn( data ) : fn;
			};
		})();
		</script>

		<link rel="stylesheet" href="libs/bootstrap/dist/css/bootstrap.min.css"/>
		<link rel="stylesheet" href="libs/editablegrid/editablegrid.css"/>
		<link rel="stylesheet" href="styles/default.css"/>
	</head>

	<template id="modal_content">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title">{%=heading.title.text%}</h4>
		</div>
		<div class="modal-body">
			{%=body%}
		</div>
		<div class="modal-footer">
			{% for (const name in footer.button) { %}
			<button type="button" name="{%=name%}" class="btn btn-default">{%=footer.button[name].text%}</button>
			{% }; %}
		</div>
	</template>

	<body>
		<div class="modal fade" tabindex="-1" role="dialog">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<!-- Voir <template> -->
				</div>
			</div>
		</div>
		<div class="page-header">
			<div class="container">
				<div class="row">
					<div class="col-md-offset-0 col-md-12">
						<span class="title">Site d'administration de Onegeo</span>
						<span name="username" class="username"></span>
						<div class="btn-group login">
							<button type="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<span class="glyphicon glyphicon-user"></span>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="menu-container">
			<div class="container">
				<div class="row">
					<div class="col-md-offset-0 col-md-12">
						<ul id="menu" class="nav nav-default" role="tablist">
							<li role="presentation">
								<a href="#home" aria-controls="home" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-home"></span></a>
							</li>
							<li role="presentation">
								<a href="#sources" aria-controls="sources" role="tab" data-toggle="tab">Sources de données</a>
							</li>
							<li role="presentation">
								<a href="#indices" aria-controls="indices" role="tab" data-toggle="tab">Profils d'indexation</a>
							</li>
							<li role="presentation">
								<a href="#services" aria-controls="services" role="tab" data-toggle="tab">Profils de recherche</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<div class="main-container">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<div class="tab-content">
							<div id="home" role="tabpanel" class="tab-pane fade in">
								<span>Page d'accueil</span>
							</div>
							<div id="sources" role="tabpanel" class="tab-pane fade in">
								<div class="buttons-on-the-right-side">
									<button type="button" name="add" class="btn btn-primary">Nouveau</button>
								</div>
								<div id="table-sources" class="table-responsive"></div>
								<nav aria-label="Page navigation" style="text-align: center;">
									<ul id="table-sources-paginator" class="pagination pagination-sm"></ul>
								</nav>
								<div class="buttons-on-the-right-side">
									<button type="button" name="remove" class="btn btn-danger">Supprimer <span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button>
									<button type="button" name="open" class="btn btn-default">Ouvrir</button>
								</div>
							</div>
							<div id="indices" role="tabpanel" class="tab-pane fade in">
								<div class="buttons-on-the-right-side">
									<button type="button" name="add" class="btn btn-primary">Nouveau</button>
								</div>
								<div id="table-indices" class="table-responsive"></div>
								<nav aria-label="Page navigation" style="text-align: center;">
									<ul id="table-indices-paginator" class="pagination pagination-sm"></ul>
								</nav>
								<div class="buttons-on-the-right-side">
									<button type="button" name="remove" class="btn btn-danger">Supprimer <span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button>
									<button type="button" name="open" class="btn btn-default">Ouvrir</button>
								</div>
							</div>
							<div id="services" role="tabpanel" class="tab-pane fade in">
								<div class="buttons-on-the-right-side">
									<button type="button" name="add" class="btn btn-primary">Nouveau</button>
								</div>
								<div id="table-services" class="table-responsive"></div>
								<nav aria-label="Page navigation" style="text-align: center;">
									<ul id="table-services-paginator" class="pagination pagination-sm"></ul>
								</nav>
								<div class="buttons-on-the-right-side">
									<button type="button" name="remove" class="btn btn-danger">Supprimer <span class="glyphicon glyphicon-trash" aria-hidden="true"></span></button>
									<button type="button" name="open" class="btn btn-default">Ouvrir</button>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

		</div>
	</body>
	<script>
$(function() {
	let onegeoClient = new OnegeoClient('/query?path=');

	let $modal = $('.modal[role="dialog"]')  // Glob!
		.modal({'backdrop': 'static', 'show': false})
		.on('hidden.bs.modal', function(e) {
			// Vide la fenêtre « modal »
			$(this).find('.modal-body').empty();
			$(this).find('.modal-title').val('');
			$(this).find('.modal-footer').find('button:not(button[name="cancel"])').remove();
		});

	let onXhrFailure = function(cb) {
		if (this.status === 401) {
			openModalSignIn(cb);
		} else {
			alert(this.status + ' - ' + this.statusText);
		};
	};

	let openModalSignIn = function(callback) {
		const $user = $('<input type="text" class="form-control" placeholder="Utilisateur"/>');
		const $pwd = $('<input type="password" class="form-control" placeholder="Mot de passe"/>');
		const $submit = $('<button type="button" class="btn btn-primary">Se connecter</button>')
			.on('click', function(e) {
				if ($user.val() && $pwd.val()) {
					onegeoClient.connect($user.val(), $pwd.val(), function(isLogged) {
						if (isLogged) {
							$('[name="username"]').text($user.val());
							$modal.modal('hide');
							typeof callback === 'function' && callback();
						} else {
							$pwd.val('');
							$user.val('').focus();
						};
					});
				} else {
					!$user.val() ? $user.focus() : $pwd.focus();
				};
			});

		$modal.find('.modal-title').text('Saisissez vos paramètres de connexion');
		$modal.find('.modal-body').append('<form/>')
			.append( $('<div class="form-group"/>').append($user) )
			.append( $('<div class="form-group"/>').append($pwd) );
		$modal.find('.modal-footer').prepend($submit);
		$modal.modal('show');
	};

	let openModalSignOut = function(callback) {
		const $submit = $('<button type="button" class="btn btn-default">Me déconnecter</button>')
			.on('click', function(e) {
				onegeoClient.disconnect(function() {
					$('[name="username"]').empty();
					typeof callback === 'function' && callback();
				});
			});

		$modal.find('.modal-title').text('Fermer la session');
		$modal.find('.modal-body').append('<p/>Vous êtes sur le point de vous déconnecter.</p>');
		$modal.find('.modal-footer').prepend($submit);
		$modal.modal('show');
	};

	let openModalRemove = function(e, grid, callback) {
		e.preventDefault();

		const $submit = $('<button type="button" class="btn btn-danger disabled" disabled>Oui, supprimer définitivement cette source</button>')
			.on('click', function(e) {
				e.preventDefault();
				typeof callback === 'function' && callback();
				e.stopPropagation();
			});

		const $input = $('<input type="text" class="form-control" placeholder="Nom de la source de données à supprimer"/>')
			.on('input', function(e) {
				if ($(this).val() === grid.getRowValues(grid.lastSelectedRowIndex)['name']) {
					$submit.removeClass('disabled').prop('disabled', false);
				} else {
					$submit.addClass('disabled').prop('disabled', true);
				};
			});

		$modal.find('.modal-title').text('Êtes-vous absolument sûr ?');
		$modal.find('.modal-body').append('\
			<p>Cette action est irreversible et supprimera <strong>définitivement</strong> cette ressource ainsi que toutes les configurations associées à celle-ci.</p>\
			<form/>\
				<div class="form-group"/>\
					<p>Pour confirmer, veuillez réécrire le nom de la ressource à supprimer.</p>'
					+ $input[0].outerHTML +
				'</div>\
			</form>'
		)
		$modal.find('.modal-footer').prepend($submit);
		$modal.modal('show');

		e.stopPropagation();
	};

	let openModalAddSource = function(e, grid, callback, paths, modes) {

		let $submit = $('<button type="button" class="btn btn-default disabled" disabled>Ajouter</button>')
			.on('click', function(e) {
				e.preventDefault();
				$modal.modal('hide');
				typeof callback === 'function' && callback();
				e.stopPropagation();
			});

		// Form URI
		const $sourceUri = $('<input list="source-options" class="form-control"/>');
		const $sourceDataList = $('<datalist id="' + $sourceUri[0].attributes['list'].value + '"/>');
		for (const value of paths) {
			$sourceDataList.append('<option value="' + value +'">' + value + '</option>');
		};

		// Form Mode
		const $sourceMode = $('<select class="form-control"/>');
		for (const key in modes) {
			$sourceMode.append('<option value="' + key +'">' + modes[key] + '</option>');
		};

		// Form Name
		const $sourceName = $('<input type="text" class="form-control"/>')
			.on('input', function(e) {
				let m;
				const regex = /^[a-z0-9_]{2,100}$/g;
				if ((m = regex.exec($(this).val())) !== null) {
					$confirmAddSource.removeClass('disabled').prop('disabled', false);
				} else {
					$confirmAddSource.addClass('disabled').prop('disabled', true);
				};
			});
	};

	let openModalSource = function(e, grid, callback) {
		const context = {
			heading: {
				title: {
					text: 'Source : ' + grid.getRowValues(grid.lastSelectedRowIndex)['name']
				}
			},
			body: {

			},
			footer: {
				button: {
					close: {
						text: 'Fermer'
					}
				}
			}
		};

		$modal.find('.modal-content').html(template('modal_content', context));
		$('#button[name="close"]').on('click', function(e) {
			e.preventDefault();
			$modal.modal('hide');
			e.stopPropagation();
		});
		$modal.modal('show');

		e.stopPropagation();
	};

	// Définition des tableaux :
	let tables = {
		sourceTable: {
			table: new Table('table-sources', 'Sources', [
				{name: 'name', label: 'Nom', editable: false, datatype: 'string'},
				{name: 'mode', label: 'Type', editable: false, datatype: 'string'},
				{name: 'uri', label: 'URI', editable: false, datatype: 'url'}
			], ['add', 'open', 'remove']),
			method: {
				add: function() { /* TODO */ },
				open: function() {
					console.log(0)
				},
				remove: function() { /* TODO */ }
			}
		},
		indexProfilesTable: {
			table: new Table('table-indices', 'Indices', [
				{name: 'name', label: 'Nom', editable: false, datatype: 'string'},
				// {name: 'resource', label: 'Ressource associée', editable: false, datatype: 'string'}
			], ['add', 'open', 'remove']),
			method: {
				add: function() { /* TODO */ },
				open: function() { /* TODO */ },
				remove: function() { /* TODO */ }
			}
		},
		searchProfilesTable: {
			table: new Table('table-services', 'Services', [
				{name: 'name', label: 'Nom', editable: false, datatype: 'string'},
				{name: 'service_url', label: 'URL du service', editable: false, datatype: 'url'},
				{name: 'extended', label: 'Extension', editable: false, datatype: 'boolean'}
			], ['add', 'open', 'remove']),
			method: {
				add: function() { /* TODO */ },
				open: function() { /* TODO */ },
				remove: function() { /* TODO */ }
			}
		}
	};

	for (let k in tables) {
		const t = tables[k];

		t.table.actions.remove = function(e) {
			openModalRemove(e, t.table.grid, t.method.remove);
		};
		t.table.actions.open = function(e) {
			openModalSource(e, t.table.grid, t.method.open);
		};
		t.table.actions.add = function(e) {
			// TODO..
			// Method.getAvailableModes(function(modes) {
			// 	Method.getAvailableSources(function(paths) {
			// 		openModalAddSource(e, t.table.grid, t.method.add, paths, modes);
			// 	}, onXhrFailure);
			// }, onXhrFailure);
		};
	};

	$('div#home[role="tabpanel"]')
		.find('button')
		.each(function() {
			$('button[name="' + this.name + '"]')
				.on('click', function(e) {
					$('a[href="#' + this.name + '"]').tab('show');
				});
		});

	$('.login button')
		.click(function() {
			if (onegeoClient.logged) {
				openModalSignOut(function() {
					window.location.reload();  // C'est moche !
				});
			} else {
				openModalSignIn(function() {/* Rien à faire */});
			};
		});

	const HASH_TAB = [];

	$('a[data-toggle="tab"]')
		.each(function(e) {
			HASH_TAB.push($(this).prop('hash'));
		})
		.on('show.bs.tab', function(e) {
			const hash = $(e.target).prop('hash');
			window.location = hash;
		})
		.on('shown.bs.tab', function(e) {/* Rien à faire */});

	$('a[data-toggle="tab"]:not([href="' + HASH_TAB[0] + '"])')
		.each(function(e) {
			$(this).click(function(e) {
				e.preventDefault();

				const trigger = function() {
					$(this).trigger('click');  // == $(this).click.call($(this));
				}.bind(this);

				const onFailure = function() {
					e.stopPropagation();
					onXhrFailure.call(this, trigger);
				};

				if (this.hash === '#sources') {
					onegeoClient.action.get('sources', {
						successful: function(data) {
							const arr = [];
							for (let i = 0; i < data.length; i ++) {
								arr.push({id: i, values: [data[i].name, data[i].mode, data[i].uri]});
							};
							tables.sourceTable.table.update(arr);
						},
						failure: onFailure
					});
				} else if (this.hash === '#indices') {
					onegeoClient.action.get('indices', {
						successful: function(data) {
							const arr = [];
							for (let i = 0; i < data.length; i ++) {
								arr.push({id: i, values: [data[i].name]});
							};
							tables.indexProfilesTable.table.update(arr);
						},
						failure: onFailure
					});
				} else if (this.hash === '#services') {
					onegeoClient.action.get('profiles', {
						successful: function(data) {
							const arr = [];
							for (let i = 0; i < data.length; i ++) {
								arr.push({id: i, values: [data[i].name, data[i].serviceUrl, data[i].extended]});
							};
							tables.searchProfilesTable.table.update(arr);
						},
						failure: onFailure
					});
				} else {
					e.stopPropagation();
				};
			});
		});

	$('a[href="' + HASH_TAB[0] + '"]').tab('show');

});

// $(window).bind('hashchange', function(e) {
// 	e.preventDefault();
// });
	</script>
</html>
