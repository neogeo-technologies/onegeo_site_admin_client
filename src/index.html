<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<title></title>
		<script>;window.isMobile=(function(a){if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))){return true;}else{return false;};})(navigator.userAgent||navigator.vendor||window.opera);</script>
		<script src="assets/libs/jquery/dist/jquery.min.js"></script>
		<script src="assets/libs/moment/min/moment-with-locales.min.js"></script>
		<script src="assets/libs/bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="assets/libs/editablegrid/editablegrid.js"></script>
		<script src="assets/libs/editablegrid/editablegrid_renderers.js"></script>
		<script src="assets/libs/editablegrid/editablegrid_editors.js"></script>
		<script src="assets/libs/editablegrid/editablegrid_validators.js"></script>
		<script src="assets/libs/editablegrid/editablegrid_utils.js"></script>
		<script src="assets/libs/editablegrid/editablegrid_charts.js"></script>
		<script src="assets/js/editablegrid_overloaded.js"></script>
		<script src="assets/js/editablegrid_utils.js"></script>
		<script src="assets/js/onegeo_client.js"></script>
		<script>
(function() {
	this.clone = function _itself(obj) {
		if (null == obj || 'object' != typeof obj) {
			return obj;
		};
		var copy = obj.constructor();
		for (var attr in obj) {
			if (obj.hasOwnProperty(attr)) {
				copy[attr] = obj[attr];
			};
		};
		return copy;
	};
})();
		</script>
		<script>
(function() {
	var cache = {};
	this.templator = function _itself(str, data) {
		var fun;
		if (/\W/.test(str)) {
			var js =
				"var _p = []; " +
				// "var print = function() { _p.push.apply(_p, arguments); }; " +
				"with (obj) { _p.push('" +
				// str
				// 	.replace(/[\r\t\n]/g, ' ')
				// 	.split('{%').join('\t')
				// 	.replace(/((^|%})[^\t]*)'/g, '$1\r')
				// 	.replace(/\t=(.*?)%}/g, "',$1,'")
				// 	.split('\t').join("');")
				// 	.split('%}').join("_p.push('")
				// 	.split('\r').join("\\'") + "');" +
				// "}; return _p.join('');"
				str
					.replace(/[\r\t\n]/g, " ")
					.replace(/'(?=[^%]*%})/g,"\t")
					.replace(/\r|\*="/g, ' ')
					.split("'").join("\\'")
					.split("\t").join("'")
					.replace(/{%=(.+?)%}/g, "',$1,'")
					.split("{%").join("');")
					.split("%}").join("_p.push('")
				+ "');}return _p.join('');";

			js = js.replace(/\&amp;/g, '&');  // Ugly..

			fun = new Function('obj', js);
		} else {
			fun = (cache[str] = cache[str]) || _itself(document.getElementById(str).innerHTML);
		};
		return data ? fun(data) : fun;
	};
})();
		</script>
		<link rel="stylesheet" href="assets/libs/bootstrap/dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="assets/libs/editablegrid/editablegrid.css"/>
		<link rel="stylesheet" href="assets/styles/default.css"/>
	</head>

	<!-- Sub-template -->
	<template id="sub_template">
		<div class="row {%= attrs.class || '' %}">
		{% for (const entry of elements) { %}
			<div class="{%= (entry.attrs && entry.attrs.class) ? entry.attrs.class : 'col-md-12' %}">
			{%= templator(entry.template, entry.data) %}
			</div>
		{% }; %}
		</div>
	</template>

	<!-- Template d'un groupe de boutons -->
	<template id="buttons_group">
		<div class="{%= attrs.class || '' %}">
		{% for (const button of buttons) { %}
			{%= templator(button.template, button.data) %}
		{% }; %}
		</div>
	</template>

	<!-- Template d'un élément "tablist" -->
	<template id="form_tablist">
		<div class="row">
			<div class="col-md-3">
				<ul class="nav nav-pills nav-stacked piled-menu" role="tablist">
					{% for (const entry of tabs) { %}
					<li role="presentation" class="{%= entry.active && 'active' %}"><a href="#{%= entry.id %}" name="{%= entry.id %}" aria-controls="{%= entry.id %}" role="tab" data-toggle="tab">{%= entry.label %}</a></li>
					{% }; %}
				</ul>
			</div>
			<div class="col-md-9">
				<div class="tab-content">
					{% for (const entry of tabs) { %}
					<div role="tabpanel" class="tab-pane fade {%= entry.active && 'in active'%}" id="{%= entry.id %}">{%= templator(entry.template, entry.data) %}</div>
					{% }; %}
				</div>
			</div>
		</div>
	</template>

	<!-- Template d'un élément "button" -->
	<template id="button">
		<button type="{%= attrs.type %}" name="{%= attrs.name %}" class="btn {%= attrs.class || 'btn-default' %}">{%= text %}</button>
	</template>

	<!-- Template d'un élément "input" -->
	<template id="form_input">
		<div class="form-group">
			{% if (attrs.label) { %}
			<label for="{%='id_' + attrs.name %}">{%= attrs.label %}</label>
			{% }; %}
			<input id="{%='id_' + attrs.name %}" name="{%= attrs.name %}" list="{%= attrs.datalist ? attrs.name : '' %}" type="{%= attrs.type %}" pattern="{%= attrs.pattern || '.*' %}" class="form-control" placeholder="{%= attrs.placeholder || '' %}" autocomplete="{%= attrs.autocomplete || 'on' %}" value="{%= attrs.value || null %}" *="{%= attrs.disabled && 'disabled' %}*="/>
			{% if (attrs.datalist) { %}
			<datalist id="{%= attrs.name %}">
				{% for (const option of attrs.datalist.options) { %}
				<option value="{%= option.value %}" *="{%= option.selected && 'selected' %} {%= option.disabled && 'disabled' %}*=">{%= option.text %}</option>
				{% }; %}
			</datalist>
			{% }; %}
		</div>
	</template>

	<!-- Template d'un élément "input group" -->
	<template id="form_input_group">
		<div class="form-group">
			{% if (attrs.label) { %}
			<label for="{%='id_' + attrs.name %}">{%= attrs.label %}</label>
			{% }; %}
			<div class="input-group">
				<span class="input-group-addon" id="{%= 'id_' + attrs.name + '_addon' %}">{%= attrs.addon || '' %}</span>
				<input id="{%='id_' + attrs.name %}" name="{%= attrs.name %}" list="{%= attrs.datalist ? attrs.name : '' %}" type="{%= attrs.type %}" pattern="{%= attrs.pattern || '.*' %}" class="form-control" placeholder="{%= attrs.placeholder || '' %}" autocomplete="{%= attrs.autocomplete || 'on' %}" value="{%= attrs.value || null %}" *="{%= attrs.disabled && 'disabled' %}*="  aria-describedby="{%= 'id_' + attrs.name + '_addon' %}"/>
			</div>
			{% if (attrs.datalist) { %}
			<datalist id="{%= attrs.name %}">
				{% for (const option of attrs.datalist.options) { %}
				<option value="{%= option.value %}" *="{%= option.selected && 'selected' %} {%= option.disabled && 'disabled' %}*=">{%= option.text %}</option>
				{% }; %}
			</datalist>
			{% }; %}
		</div>
	</template>

	<!-- Template d'un élément "select" -->
	<template id="form_select">
		<div class="form-group">
			{% if (attrs.label) { %}
			<label for="{%='id_' + attrs.name %}">{%= attrs.label %}</label>
			{% }; %}
			<select id="{%='id_' + attrs.name %}" name="{%= attrs.name %}" class="form-control">
			{% for (const option of options) { %}
				<option value="{%= option.value %}" *="{%= option.selected && 'selected' %} {%= option.disabled && 'disabled' %}*=">{%= option.text %}</option>
			{% }; %}
			</select>
		</div>
	</template>

	<!-- Template d'un élément "multiselect" -->
	<template id="form_multiselect">
		<div class="form-group">
			{% if (attrs.label) { %}
			<label for="{%='id_' + attrs.name %}">{%= attrs.label %}</label>
			{% }; %}
			<select multiple id="{%='id_' + attrs.name %}" name="{%= attrs.name %}" class="form-control">
			{% for (const option of options) { %}
				<option value="{%= option.value %}" *="{%= option.selected && 'selected' %} {%= option.disabled && 'disabled' %}*=">{%= option.value %}</option>
			{% }; %}
			</select>
		</div>
	</template>

	<!-- Template d'un élément "textarea" -->
	<template id="form_textarea">
		<div class="form-group">
			<label for="{%='id_' + attrs.name %}">{%= attrs.label %}</label>
			<textarea id="{%='id_' + attrs.name %}" name="{%= attrs.name %}" class="form-control {%= attrs.class %}" rows="{%= attrs.rows %}"></textarea>
		</div>
	</template>

	<!-- Template d'un élément "checkbox" -->
	<template id="form_checkbox">
		<div class="form-group">
			<label>
				<input id="{%='id_' + attrs.name %}" name="{%= attrs.name %}" type="checkbox" *="{%= attrs.selected && 'selected' %} {%= attrs.checked && 'checked' %}*="> {%= attrs.label %}
			</label>
		</div>
	</template>

	<!-- Template d'un élément "p" -->
	<template id="paragraph">
		<p>{%= text %}</p>
	</template>

	<!-- Template d'un élément "label" -->
	<template id="label">
		<label>{%= text %}</label>
	</template>

	<!-- Template d'un élément "span" -->
	<template id="span">
		<span class="{%= attrs.class || '' %}">{%= text %}</span>
	</template>

	<!-- Template de la fenêtre "modal" -->
	<template id="modal">
		<div class="modal fade" tabindex="-1" role="dialog">
			<div class="modal-dialog {%= dialog.class || '' %}" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" name="close" class="close" data-dismiss="modal" aria-label="Close">
							<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>
						</button>
						<h4 class="modal-title">{%= heading.title.text %}</h4>
					</div>
					<form onsubmit="{%=body.onsubmit || 'return false;' %}">
						<div class="modal-body">
							{% for (const entry of body.elements) { %}
								{%= templator(entry.template, entry.data) %}
							{% }; %}
						</div>
						<div class="modal-footer">
							{% for (const entry of footer.elements) { %}
								{%= templator(entry.template, entry.data) %}
							{% }; %}
						</div>
					</form>
				</div>
			</div>
		</div>
	</template>

	<!-- Template de la fenêtre "carousel" -->
	<template id="carousel">
		<div id="{%= 'id_' + name %}" name="{%= name %}" class="carousel slide" data-ride="carousel">
			<div class="carousel-inner" role="listbox">
			{% for (let i in slides) { %}
				<div class="{%= i == 0 ? 'item active' : 'item' %}">
					{%= templator(slides[i].template, slides[i].data) %}
				</div>
			{% }; %}
			</div>
		</div>
	</template>

	<!-- Template du tableau "editablegrid" -->
	<template id="table_grid">
		<div id="table-{%= name %}" class="table-responsive"></div>
		<nav aria-label="Page navigation" style="text-align: center;">
			<ul id="table-{%= name %}-paginator" class="pagination pagination-sm"></ul>
		</nav>
	</template>

	<!-- Corps de la page -->
	<body>
		<div class="progress bar-on-top">
			<div class="progress-bar" role="progressbar" style="width: 0%"></div>
		</div>
		<nav class="navbar navbar-default">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<div class="navbar-header">
							<a class="navbar-brand" href="#home">
								<span id="site_brand"></span>
								<span id="site_title"></span>
							</a>
						</div>
						<div class="navbar-right">
							<button id="sign_in" type="button" class="btn navbar-btn">
								<span id="identity"></span>
								<span class="glyphicon glyphicon-user"></span>
							</button>
						</div>
					</div>
				</div>
			</div>
		</nav>
		<div class="menu-container">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<ul id="menu" class="nav nav-tabs" role="tablist">
							<li role="presentation">
								<a href="#home" aria-controls="home" role="tab" data-toggle="tab">
									<span class="glyphicon glyphicon-home"></span>
								</a>
							</li>
							<li role="presentation">
								<a href="#sources" aria-controls="sources" role="tab" data-toggle="tab">Sources de données</a>
							</li>
							<li role="presentation">
								<a href="#indexes" aria-controls="indexes" role="tab" data-toggle="tab">Profils d'indexation</a>
							</li>
							<li role="presentation">
								<a href="#services" aria-controls="services" role="tab" data-toggle="tab">Profils de recherche</a>
							</li>
							<li role="presentation">
								<a href="#tasks" aria-controls="tasks" role="tab" data-toggle="tab">Tableau de bord</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<div class="main-container">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<div class="tab-content">
							<div id="home" role="tabpanel" class="tab-pane fade in">
								<p>Bienvenu sur la page d'accueil</p>
								<p>
									TODO :
									<ul>
										<li>Si connecté
											<ul>
												<li>Des statistiques sur le comptes</li>
												<li>L'état des dernières tâches exécutées</li>
											</ul>
										</li>
										<li>Sinon
											<ul>
												<li>Un guide</li>
											</ul>
										</li>
									</ul>
								</p>
							</div>
							<div id="sources" role="tabpanel" class="tab-pane fade in"></div>
							<div id="indexes" role="tabpanel" class="tab-pane fade in"></div>
							<div id="services" role="tabpanel" class="tab-pane fade in"></div>
							<div id="tasks" role="tabpanel" class="tab-pane fade in"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="footer navbar-fixed-bottom">
			<div class="container">
				<div class="row">
					<div class="col-md-12" style="text-align: center;">
						<p>© <span name="current-year"></span> <a href='http://www.neogeo.fr' target="blank">Neogeo-Technologies</p>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script>
$(function() {
	return (function(callback) {
		const xhr = new XMLHttpRequest();
		xhr.overrideMimeType('application/json');
		xhr.open('GET', 'config/settings.json', true);
		xhr.onreadystatechange = function() {
			if (xhr.readyState == 4 && xhr.status == '200') {
				callback(JSON.parse(xhr.responseText));
			};
		};
		xhr.send(null);
	})(function(settings) {
		const window = this;

		const onegeoClient = new OnegeoClient((settings.url || window.location.origin) + settings.path);

		const onXhrFailure = function(callback) {
			if (this.status === 401) {
				return modal_SignIn(callback);
			};

			let responseJSON;
			try {
				responseJSON = JSON.parse(this.responseText);
			} catch (error) {
				// TODO
			};

			const message = (responseJSON && responseJSON.error) ? responseJSON.error : this.status + ' (' + this.statusText + ')';
			if ($('.modal').is(':visible')) {
				$('.modal').on('hidden.bs.modal', modal_Error.apply(window, [message, callback])).modal('hide');
			} else {
				modal_Error(message, callback);
			};

		};

		const disabledButton = function($button) {
			$button.addClass('disabled').prop('disabled', true);
		};

		const enabledButton = function($button) {
			$button.removeClass('disabled').prop('disabled', false);
		};

		const getTemplate = function(type, name) {
			return settings.template[type][name];
		};

		const killModal = function() {
			$('.modal-backdrop').remove();
			$('body').removeClass('modal-open');
			$('.modal').remove();
		};

		const getModal = function() {
			return $('.modal')
				.modal({
					'backdrop': 'static',
					'show': false
				})
				.on('show.bs.modal', function(e) {})
				.on('hide.bs.modal', function(e) {})
				.on('hidden.bs.modal', killModal);
		};

		const getCarousel = function() {
			return $('.carousel').carousel({
				interval: false,
				wrap: false,
				keyword: false
			});
		};

		const refreshProgressBar = function(e) {
			let value = 0;
			if (e.lengthComputable) {
				value = Math.round(e.loaded / e.total * 100);
				$('.progress-bar').css('width', value + '%');
			};
			value == 100 && setTimeout(function() {
				$('.progress-bar').css('display', 'none');
				$('.progress-bar').css('width', '0%');
				setTimeout(function() {
					$('.progress-bar').css('display', 'block');
				}, 606);
			}, 606);
		};

		const modal_Error = function(message, callback) {
			killModal();
			const calleeName = arguments.callee.name.split('_');
			$('body').prepend(templator(calleeName[0], getTemplate(calleeName[0], calleeName[1])));
			const $modal = getModal();

			$modal.find('p').text(message);

			$modal.find('button[name="close"]').click(function(e) {
				$modal.on('hide.bs.modal', function() {
					typeof callback === 'function' && callback();
				}).modal('hide');
			});

			$modal.modal('show');
		};

		const modal_SignIn = function(callback) {
			const calleeName = arguments.callee.name.split('_');
			$('body').prepend(templator(calleeName[0], getTemplate(calleeName[0], calleeName[1])));
			const $modal = getModal();

			$modal.find('button[name="submit"]').click(function(e) {
				const $username = $modal.find('input[name="username"]');
				const $password = $modal.find('input[name="password"]');
				if ($username.val() && $password.val()) {
					onegeoClient.connect($username.val(), $password.val(), function(isLogged) {
						if (isLogged) {
							$('#identity').text($username.val());
							$modal.modal('hide');
							typeof callback === 'function' && callback();
						} else {
							$password.val('');
							$username.val('').focus();
						};
					});
				} else {
					!$username.val() ? $username.focus() : $password.focus();
				};
			});

			$modal.find('button[name="close"]').click(goHome);

			$modal.modal('show');
		};

		const modal_SignOut = function(callback) {
			const calleeName = arguments.callee.name.split('_');
			$('body').prepend(templator(calleeName[0], getTemplate(calleeName[0], calleeName[1])));
			const $modal = getModal();

			$modal.find('button[name="submit"]').click(function(e) {
				onegeoClient.disconnect(function() {
					$('[name="identity"]').empty();
					typeof callback === 'function' && callback();
				});
			});

			$modal.modal('show');
		};

		const modal_Delete = function(value, deleteCallback) {
			const calleeName = arguments.callee.name.split('_');
			$('body').prepend(templator(calleeName[0], getTemplate(calleeName[0], calleeName[1])));
			const $modal = getModal();

			const $button = $modal.find('button[name="submit"]').addClass('disabled').prop('disabled', true);

			const $name = $modal.find('input[name="name"]').on('input', function(e) {
				if ($(this).val() === value) {
					$button.removeClass('disabled').prop('disabled', false);
				} else {
					$button.addClass('disabled').prop('disabled', true);
				};
			});

			$modal.find('button[name="submit"]').click(function(e) {
				if ($name.val() === value) {
					typeof deleteCallback === 'function' && deleteCallback(function(location) {
						$modal.on('hidden.bs.modal', function(e) {
							getThenLoad.call(this, location.split('/')[1])();
						}).modal('hide');
					});
				};
			});

			$modal.modal('show');
		};

		const modal_AddSource = function(getURICallback, getProtocolCallback, postSourceCallback) {
			const calleeName = arguments.callee.name.split('_');
			$('body').prepend(templator(calleeName[0], getTemplate(calleeName[0], calleeName[1])));
			const $modal = getModal();

			// Moche
			const $carousel = getCarousel();

			// Définit les actions..
			const $name = $modal.find('input[name="name"]').on('input', function() {
				let m;
				const regex = /^[a-z0-9_]{3,100}$/g;
				((m = regex.exec($(this).val())) !== null) ? enabledButton($next) : disabledButton($next);
			});

			const $uri = $modal.find('input[name="uri"]').on('input', function() {
				$(this).val().length > 0 ? enabledButton($next) : disabledButton($next);
			})

			const $protocol = $modal.find('select[name="protocol"]').on('change', function(e) {
				enabledButton($next)
			});
			// bouton close
			const $close= $modal.find('button[name="close"]').click(function(e) {
						$modal.on('hidden.bs.modal', function(e) {
							getThenLoad.call(this, 'sources')();
						}).modal('hide');
			});
			$close.hide();

			const $next = $modal.find('button[name="next"]').click(function(e) {
				e.stopPropagation();

				$carousel.one('slide.bs.carousel', function(e) {
					disabledButton($next);

					const i = $carousel.find('.active').index() + 1;

					if (i === 1) {
						typeof getURICallback === 'function' && getURICallback(function(data) {
							const $datalist = $uri.siblings('datalist#' + $uri.attr('name')).empty();
							for (const entry of data) {
								$datalist.append($('<option>', {
									value: entry,
									text: entry
								}));
							};
						});
					};
					if (i === 2){

						typeof getProtocolCallback === 'function' && getProtocolCallback(function(data) {
							for (const key in data) {
								$protocol.append($('<option>', {
									value: key,
									text: data[key]
								}));
							};
						});
						$next["0"].childNodes[0].data ="Créer"
					};
					if (i === 3) {

						$next.hide();
						$close.show();
						typeof postSourceCallback === 'function' && postSourceCallback({
							name: $name.val(),
							uri: $uri.val(),
							protocol: $protocol.val() // Deprecated
						}, function(data) {

							if (this.status === 201) {
								$modal.on('hidden.bs.modal', function(e) {
									// on rafraîchit le tableau
									getThenLoad.call(this, 'sources')();
								}).modal('hide');
							};
							if (this.status == 200) {

								onegeoClient.action.get(data.task_url, {
									successful: function(data) {

										// tâche terminée
										if (this.status === 200 ) {
											console.log(data)
											$modal.on('hidden.bs.modal', function(e) {
												getThenLoad.call(this, 'sources')();
											}).modal('hide');
										};
									},
									failure: function() {
										onXhrFailure.call(this);
									}
								})
							};
						});
					};

				}).carousel(this.name);
			});

			const $submit = $modal.find('button[name="submit"]').hide().click(function(e) {
				typeof callback === 'function' && callback({
					// TODO
				});
			});

			disabledButton($next);
			disabledButton($submit);

			$modal.modal('show');
		};

		const modal_UpdateSource = function(data, putSourceCallback) {
			const _cloned = clone(data);

			const calleeName = arguments.callee.name.split('_');
			const template = getTemplate(calleeName[0], calleeName[1])
			$('body').prepend(templator(calleeName[0], getTemplate(calleeName[0], calleeName[1])));

			const $modal = getModal();

			const $carousel = getCarousel();

			const $previous = $modal.find('button[name="previous"]').hide().click(function(e) {
				e.preventDefault();
				$carousel.on('slid.bs.carousel', function(e) {
					$previous.hide();
				}).carousel(0);
			});

			const close = function(e) {
				$modal.modal('hide');
			};

			const $cancel = $modal.find('button[name="cancel"]').click(close);

			const $submit = $modal.find('button[name="submit"]').click(function(e) {
				typeof putSourceCallback === 'function' && putSourceCallback(_cloned, function(location) {
					$modal.on('hidden.bs.modal', function(e) {
						getThenLoad.call(this, 'sources')();
					}).modal('hide');
				});
			});

			const loadResourcesTable = function(data) {
				const arr = [];
				for (let i = 0; i < data.length; i ++) {
					arr.push({
						id: i,
						values: [
							data[i].name,
							data[i].location,
							data[i].columns
						]
					});
				};
				table['resources'].method['open'] = function(e) {
					e.preventDefault();
					const grid = table['resources'].grid;
					const entry = grid.getRowValues(grid.lastSelectedRowIndex);
					grid.lastSelectedRowIndex > -1 && $carousel
						.on('slide.bs.carousel', function(e) {
							for (const key of ['location', 'name']) {
								$modal.find('input[name="entry-' + key + '"]').val(entry[key]);
							};
							loadColumnsTable(entry.columns);
						})
						.on('slid.bs.carousel', function(e) {
							$previous.show();
						})
						.carousel(1);
				};
				table['resources'].update(arr);
			};

			const loadColumnsTable = function(data) {
				const arr = [];
				for (let i = 0; i < data.length; i ++) {
					arr.push({
						id: i,
						values: [
							data[i].name,
							data[i].type || null,
							data[i].occurs ? '[' + data[i].occurs[0] + ', ' + data[i].occurs[1] + ']' : null
						]
					});
				};
				table['columns'].update(arr);
			};

			loadResourcesTable(data.resources);

			for (const key of ['protocol', 'uri']) {
				$modal.find('input[name="' + key + '"]').val(data[key]);
			};

			$modal.find('input[name="location"]').val(data['location'].split('/').pop()).on('change', function(e) {
				_cloned.name = this.value;
			});

			$modal.find('input[name="name"]').val(data['name']).on('change', function(e) {
				_cloned.name = this.value;
			});

			$modal.modal('show');
		};

		const modal_CreateIndex = function(getSourcesCallback, getResourceCallback, postIndexCallback) {

			const calleeName = arguments.callee.name.split('_');
			$('body').prepend(templator(calleeName[0], getTemplate(calleeName[0], calleeName[1])));

			const $modal = getModal();
			const $carousel = getCarousel();

			const $name = $modal.find('input[name="name"]').on('input', function() {
				let m;
				const regex = /^[a-z0-9_]{3,100}$/g;
				((m = regex.exec($(this).val())) !== null) ? enabledButton($next) : disabledButton($next);
			});

			const $source = $modal.find('select[name="source"]').on('change', function(e) {
				enabledButton($next);
			});

			const $resource = $modal.find('select[name="resource"]').on('change', function(e) {
				enabledButton($submit);
			});

			const $next = $modal.find('button[name="next"]').click(function(e) {
				e.stopPropagation();
				// TODO: Reprendre l'ordre des callbacks
				$carousel.on('slide.bs.carousel', function(e) {
					disabledButton($next);
					const i = $carousel.find('.active').index() + 1;
					if (i === 1) {
						typeof getSourcesCallback === 'function' && getSourcesCallback(function(data) {
							for (const entry of data) {
								$source.append($('<option>', {
									value: entry.location,
									text: entry.name
								}));
							};
						});
					};
					if (i === 2 && $source.val()) {
						$next.hide();
						$submit.show();
						typeof getSourcesCallback === 'function' && getResourceCallback($source.val() + '/resources', function(data) {
							for (const entry of data) {
								$resource.append($('<option>', {
									value: entry.location,
									text: entry.location
								}));
							};
						});
					}
				}).carousel(this.name);
			});

			const $submit = $modal.find('button[name="submit"]').hide().click(function(e) {
				typeof postIndexCallback === 'function' && postIndexCallback({
					name: $name.val(),
					resource: $resource.val()
				}, function(location) {
					$modal.on('hidden.bs.modal', function(e) {
						getThenLoad.call(this, 'indexes')();
					}).modal('hide');
				});
			});

			disabledButton($next);
			disabledButton($submit);

			$modal.modal('show');
		};

		const modal_UpdateIndex = function(data, putIndexCallback) {
			const _cloned = clone(data);

			const updateColumn = function(columnName, attribute, value) {
				for (let i = 0; i < _cloned.columns.length ; i ++) {
					if (_cloned.columns[i].name == columnName) {
						_cloned.columns[i][attribute] = value;
					};
				};
			};

			const getColumn = function(columnName) {
				for (const column of _cloned.columns) {
					if (columnName == column.name) {
						return column;
					};
				};
			};

			const generateTemplate = function(data) {
				const template = {
					attrs: {},
					elements: [
					{
						template: 'sub_template',
						data:
						{
							attrs: {},
							elements: [
							{
								template: 'form_input',
								data: {
									attrs: {
										name: 'column-name',
										type: 'text',
										label: 'Nom',
										autocomplete: 'off',
										value: data.name,
										disabled: true
									}
								}
							}, {
								template: 'form_input',
								data: {
									attrs: {
										name: 'column-alias',
										type: 'text',
										label: 'Alias',
										autocomplete: 'off',
										value: data.alias,
										disabled: true
									}
								}
							}, {
								template: 'form_input',
								data: {
									attrs: {
										name: 'column-type',
										type: 'text',
										label: 'Type',
										autocomplete: 'off',
										value: data.type,
										disabled: true
									}
								}
							}]
						}
					}]
				};

				if (data.type == 'text') {
					template.elements.push({
						template: 'form_checkbox',
						data: {
							attrs: {
								name: 'searchable',
								label: 'Activer l\'analyser et la recherche sur cet attribut',
								checked: data.searchable ? 'checked' : ''
							}
						}
					});
					template.elements.push({
						template: 'form_select',
						data: {
							attrs: {
								name: 'analyzer',
								type: 'text',
								label: 'Analyseur utilisé lors de l\'indexation des données'
							},
							options: [
								{
									value: 'default',
									text: 'Utiliser l\'analyseur par défaut',
									selected: true
								}
							]
						}
					});
					template.elements.push({
						template: 'form_select',
						data: {
							attrs: {
								name: 'search_analyzer',
								type: 'text',
								label: 'Analyseur utilisé lors d\'une recherche'
							},
							options: [
								{
									value: 'default',
									text: 'Utiliser l\'analyseur pour l\'indexation des données (valeur par défaut)',
									selected: true
								}
							]
						}
					});
				};

				if (data.type == 'date') {
					template.elements.push({
						template: 'form_input',
						data: {
							attrs: {
								name: 'pattern',
								type: 'text',
								value: data.pattern,
								label: 'Motif',
								placeholder: 'Par défaut : « epoch_millis »',
								autocomplete: 'off'
							}
						}
					});
				};

				template.elements.push({
					template: "buttons_group",
					data: {
						attrs: {
							class: 'buttons-on-the-left-side'
						},
						buttons: [
						{
							template: "button",
							data:
							{
								text: "<span class=\"glyphicon glyphicon-arrow-left\" aria-hidden=\"true\"></span> Revenir",
								attrs:
								{
									name: "previous",
									type: "button"
								}
							}
						}, {
							template: "button",
							data:
							{
								text: "Sauvegarder",
								attrs:
								{
									name: "save",
									type: "button"
								}
							}
						}]
					}
				});

				return template;
			};

			const calleeName = arguments.callee.name.split('_');
			const template = getTemplate(calleeName[0], calleeName[1])
			$('body').prepend(templator(calleeName[0], template));

			const $modal = getModal();
			const $carousel = getCarousel();

			const arr = [];
			for (let i = 0; i < data.columns.length; i ++) {
				arr.push({
					id: i,
					values: [
						data.columns[i].rejected ? false : true,
						data.columns[i].name,
						data.columns[i].alias,
						data.columns[i].type,
						templator('button', {
							text: 'Configuration avancée <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>',
							attrs: {
								name: 'edit',
								type: 'button',
								class: 'btn-default btn-xs'
							}
						})
					]
				});
			};

			table['index-columns'].update(arr);

			const toSecondSlide = function() {
				$carousel.carousel(1);
			};

			const toFirstSlide = function() {
				$carousel.carousel(0);
			};

			const close = function(e) {
				$modal.modal('hide');
			};

			const $cancel = $modal.find('button[name="cancel"]').click(close);

			const $submit = $modal.find('button[name="submit"]').click(function(e) {
				typeof putIndexCallback === 'function' && putIndexCallback(_cloned, function(location) {
					$modal.on('hidden.bs.modal', function(e) {
						getThenLoad.call(this, 'indexes')();
					}).modal('hide');
				});
			});

			$('.modal li[role="presentation"]>a[data-toggle="tab"]').each(function(e) {
				$(this).click(function(e) {
					const that = this;
					if ($carousel.find('.active').index() > 0) {
						e.stopPropagation();
						$carousel.on('slid.bs.carousel', function(e) {
							$('a[href="#' + that.name + '"]').tab('show');
						});
						toFirstSlide();
					} else {
						$carousel.off('slid.bs.carousel');
					};
				});
			});

			$carousel.on('slid.bs.carousel', function(e) {
				if ($carousel.find('.active').index() > 0) {
					disabledButton($submit);
				} else {
					enabledButton($submit);
				};
			});

			table['index-columns'].options.onChange = function(rowIndex, columnIndex, oldValue, newValue, row) {
				updateColumn(this.grid.getValueAt(rowIndex, this.grid.getColumnIndex('name')), this.grid.getColumnName(columnIndex), newValue);
			};

			table['index-columns'].method.edit = function(e, rowIndex) {
				const columnName = this.grid.getValueAt(rowIndex, this.grid.getColumnIndex('name'));
				$('.carousel-inner').find('.item').last().empty().append(templator('sub_template', generateTemplate(getColumn(columnName))));
				for (const key of ['name', 'alias', 'type']) {
					$modal.find('input[name="' + key + '"]').val(data[key]);
				};
				const $previous = $modal.find('button[name="previous"]').click(toFirstSlide);
				const $save = $modal.find('button[name="save"]').click(function(e) {
					$('.carousel-inner').find('.item').last().find('input,select').each(function() {
						updateColumn(columnName, this.name, this.type == 'checkbox' ? this.checked : this.value);
					});
					toFirstSlide();
				});
				toSecondSlide();
			};

			$modal.find('input[name="name"]').val(data['name']).on('change', function(e) {
				_cloned.name = this.value;
			});
			$modal.find('input[name="location"]').val(data['location'].split('/').pop()).on('change', function(e) {
				_cloned.alias = this.value;
			});
			$modal.find('select[name="reindex-frequency"]').on('change', function(e) {
				_cloned.reindex_frequency = this.value;
			});

			$modal.modal('show');
		};

		const modal_CreateService = function(getIndexesCallback, postServiceCallback) {
			const calleeName = arguments.callee.name.split('_');
			$('body').prepend(templator(calleeName[0], getTemplate(calleeName[0], calleeName[1])));
			const $modal = getModal();

			const $carousel = getCarousel();

			// Définit les actions..
			const $name = $modal.find('input[name="name"]').on('input', function() {
				let m;
				const regex = /^[a-z0-9_]{3,100}$/g;
				((m = regex.exec($(this).val())) !== null) ? enabledButton($next) : disabledButton($next);
			});

			const $indexes = $modal.find('select[name="indexes"]');

			const $next = $modal.find('button[name="next"]').click(function(e) {
				e.stopPropagation();
				$carousel.on('slide.bs.carousel', function(e) {
					disabledButton($next);
					const i = $carousel.find('.active').index() + 1;
					if (i === 1) {
						$next.hide();
						$submit.show();
						enabledButton($submit);
						typeof getIndexesCallback === 'function' && getIndexesCallback(function(data) {
							$indexes.empty();
							for (const entry of data) {
								$indexes.append($('<option>', {
									value: entry.location,
									text: entry.name
								}));
							};
						});
					};
				}).carousel(this.name);
			});

			const $submit = $modal.find('button[name="submit"]').hide().click(function(e) {
				typeof postServiceCallback === 'function' && postServiceCallback({
					name: $name.val(),
					indexes: $indexes.val()
				}, function(location) {
					$modal.on('hidden.bs.modal', function(e) {
						getThenLoad.call(this, 'services')();
					}).modal('hide');
				});
			});

			disabledButton($next);
			disabledButton($submit);

			$modal.modal('show');
		};


		const modal_UpdateService = function(data, indexes, putServiceCallback) {
			const calleeName = arguments.callee.name.split('_');
			$('body').prepend(templator(calleeName[0], getTemplate(calleeName[0], calleeName[1])));
			const $modal = getModal();
			const $carousel = getCarousel();

			const _cloned = clone(data);

			$modal.find('input[name="name"]').val(data['name']).on('change', function(e) {
				_cloned.name = this.value;
			});

			$modal.find('input[name="location"]').val(data['location'].split('/').pop()).on('change', function(e) {
				_cloned.name = this.value;
			});

			const $indexes = $modal.find('select[name="indexes"]').on('change', function(e) {
				_cloned.indexes = [];
				$('option:selected', this).each(function() {
					_cloned.indexes.push(this.value);
				});
			});
			for (const index of indexes) {
				$indexes.append($('<option>', {
					value: index.location,
					text: index.location,
					selected: (data.indexes.indexOf(index.location) > -1) ? true : false
				}));
			};
			$queryDsl = $('textarea[name="query-dsl"]')
				.keydown(function(e) {
					if (e.keyCode === 9) {
						const $this = $(this);
						const start = this.selectionStart;
						const end = this.selectionEnd;
						const val = $this.val();
						$this.val(val.substring(0, start) + '\t' + val.substring(end));
						this.selectionStart = this.selectionEnd = start + 1;
						e.preventDefault();
					};
				})
				.val(JSON.stringify(data.config, null, 4))
				.on('change', function(e) {
					_cloned.config = this.value;
				});

			table['qs-params'].update(data.qs_params || []);

			$modal.find('button[name="cancel"]').click(function(e) {
				$modal.modal('hide');
			});

			$modal.find('button[name="submit"]').click(function(e) {
				typeof putServiceCallback === 'function' && putServiceCallback(_cloned, function(location) {
					$modal.on('hidden.bs.modal', function(e) {
						getThenLoad.call(this, 'services')();
					}).modal('hide');
				});
			});

			$modal.modal('show');
		};

		const getThenLoad = function(key, options) {
			const load = {
				'sources': function() {
					return function(data) {
						return loadTable('sources', parseData(data, [
							'name',
							'protocol',
							'uri',
							'location'
						]));
					};
				},
				'indexes': function() {
					return function(data) {
						return loadTable('indexes', parseData(data, [
							'name',
							'resource.name',
							'location'
						]));
					};
				},
				'services': function() {
					return function(data) {
						return loadTable('services', parseData(data, [
							'name',
							'indexes.name',
							'location'
						]));
					};
				},
				'tasks': function() {
					return function(data) {
						return loadTable('tasks', parseData(data, [
							'id',
							'status',
							'location'
						]));
					};
				}
			};

			const opts = options ? options : {};
			const data =  opts.data ? opts.data : undefined;
			const onSuccess = (typeof opts.successful == 'function') ? opts.successful : load[key].apply(window, arguments);
			const onDownloadProgress = (typeof opts.downprogress == 'function') ? opts.downprogress : function() {};
			const onFailure = (typeof opts.failure == 'function') ? opts.failure : function() {
				onXhrFailure.call(this);
			};

			return function() {
				onegeoClient.action.get('/' + key, {
					data: data,
					successful: onSuccess,
					failure: onFailure,
					downprogress: onDownloadProgress
				});
			};
		};

		// Définition des tableaux :
		const table = {

			// Tableau des sources de données :
			'sources': new Table('table-sources', 'Sources', [{
				name: 'name',
				label: 'Nom',
				editable: false,
				datatype: 'string'
			}, {
				name: 'protocol',
				label: 'Protocole',
				editable: false,
				datatype: 'string'
			}, {
				name: 'uri',
				label: 'URI',
				editable: false,
				datatype: 'url'
			}, {
				name: 'location',
				label: '_HIDDEN',
				editable: false,
				datatype: 'string'
			}], {
				'add': {
					method: function(e) {
						e.preventDefault();
						e.stopPropagation();
						const grid = this.grid;
						modal_AddSource(
							function(callback) {
								onegeoClient.action.get('/sources_directories', {
									successful: function(data) {
										typeof callback === 'function' && callback(data);
									},
									failure: function() {
										onXhrFailure.call(this);
									}
								})
							},
							function(callback) {
								onegeoClient.action.get('/supported_modes', {
									successful: function(data) {
										typeof callback === 'function' && callback(data);
									},
									failure: function() {
										onXhrFailure.call(this);
									}
								})
							},
							function(data, callback) {
								onegeoClient.action.post('/sources', {
									data: data,
									successful: function(data) {
										// console.log('New source created: ' + location.task_url);
										typeof callback === 'function' && callback.call(this, data);
									},
									failure: function() {
										onXhrFailure.call(this, getThenLoad.call(this, 'sources'));
									}
								})
							},

						);
					},
					position: 'before',
					html: templator('button', {
						text: 'Nouveau',
						attrs: {
							name: 'add',
							type: 'button',
							class: 'btn-primary'
						}
					})
				},
				'open': {
					method: function(e) {
						e.preventDefault();
						e.stopPropagation();
						const grid = this.grid;
						const entry = grid.getRowValues(grid.lastSelectedRowIndex);
						onegeoClient.action.get(entry.location, {
							successful: function(data) {
								const sourceData = data;
								onegeoClient.action.get(entry.location + '/resources', {
									successful: function(data) {
										sourceData['resources'] = data;
										modal_UpdateSource(sourceData, function(data, callback) {
											onegeoClient.action.put(entry.location, {
												data: data,
												successful: function(location) {
													console.log('Source updated: ' + location);
													typeof callback === 'function' && callback(data);
												},
												failure: function() {
													onXhrFailure.call(this, getThenLoad.call(this, 'sources'));
												},
												upprogress: refreshProgressBar
											})
										});
									},
									failure: function() {
										onXhrFailure.call(this);
									}
								});
							},
							failure: function() {
								onXhrFailure.call(this);
							}
						});
					},
					position: 'after',
					html: templator('button', {
						text: 'Configurer <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>',
						attrs: {
							name: 'open',
							type: 'button'
						}
					})
				},
				'remove': {
					method: function(e) {
						e.preventDefault();
						e.stopPropagation();
						const grid = this.grid;
						const entry = grid.getRowValues(grid.lastSelectedRowIndex);
						modal_Delete(entry.name, function(callback) {
							onegeoClient.action.delete(entry.location, {
								successful: function() {
									console.log('Source deleted: ' + entry.location);
									typeof callback === 'function' && callback(entry.location);
								},
								failure: function() {
									onXhrFailure.call(this, getThenLoad.call(this, 'sources'));
								}
							})
						});
					},
					position: 'after',
					html: templator('button', {
						text: 'Supprimer <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>',
						attrs: {
							name: 'remove',
							type: 'button',
							class: 'btn-danger'
						}
					})
				}
			}),

			// Tableau des ressources :
			'resources': new Table('table-resources', 'Resources', [{
				name: 'name',
				label: 'Nom',
				editable: false,
				datatype: 'string'
			}, {
				name: 'location',
				label: '_HIDDEN',
				editable: false,
				datatype: 'string'
			}, {
				name: 'columns',
				label: '_HIDDEN',
				editable: false,
				datatype: 'object'
			}], {
				'open': {
					position: 'after',
					html: templator('button', {
						text: 'Ouvrir',
						attrs: {
							name: 'open',
							type: 'button',
							class: 'btn-default'
						}
					})
				}
			}),

			// Tableau des propriétés de données :
			'columns': new Table('table-columns', 'Columns', [{
				name: 'name',
				label: 'Nom',
				editable: false,
				datatype: 'string'
			}, {
				name: 'type',
				label: 'Type',
				editable: false,
				datatype: 'string'
			}, {
				name: 'occurs',
				label: 'Occurence',
				editable: false,
				datatype: 'string'
			}], null, {
				selectable: false
			}),

			// Tableau des propriétés de données :
			'index-columns': new Table('table-index-columns', 'IndexColumns', [{
				name: 'rejected',
				label: 'Activé',
				editable: true,
				datatype: 'boolean'
			}, {
				name: 'name',
				label: 'Nom',
				editable: false,
				datatype: 'string'
			}, {
				name: 'alias',
				label: 'Alias',
				editable: true,
				datatype: 'string'
			}, {
				name: 'type',
				label: 'Type',
				editable: true,
				datatype: 'string',
				values: {
					boolean: 'boolean',
					date: 'date',
					keyword: 'keyword',
					pdf: 'pdf',
					text: 'text'
				}
			}, {
				name: 'edit',
				label: 'Configuration avancée',
				editable: false,
				datatype: 'html'
			}], {
				'edit': {
					position: 'inner',
					method: function(e) {}
				}
			}, {
				selectable: false
			}),

			// Tableau des profils d'indexation :
			'indexes': new Table('table-indexes', 'Indexes', [{
				name: 'name',
				label: 'Nom',
				editable: false,
				datatype: 'string'
			}, {
				name: 'resource_location',
				label: 'Ressource',
				editable: false,
				datatype: 'string'
			}, {
				name: 'location',
				label: '_HIDDEN',
				editable: false,
				datatype: 'string'
			}], {
				'add': {
					method: function(e) {
						e.preventDefault();
						e.stopPropagation();
						const grid = this.grid;
						modal_CreateIndex(
							function(callback) {
								onegeoClient.action.get('/sources', {
									successful: function(data) {
										typeof callback === 'function' && callback(data);
									},
									failure: function() {
										onXhrFailure.call(this);
									}
								})
							},
							function(resourceLocation, callback) {
								onegeoClient.action.get(resourceLocation, {
									successful: function(data) {
										typeof callback === 'function' && callback(data);
									},
									failure: function() {
										onXhrFailure.call(this);
									}
								})
							},
							function(data, callback) {
								onegeoClient.action.post('/indexes', {
									data: data,
									successful: function(location) {
										console.log('New index created: ' + location);
										typeof callback === 'function' && callback(data);
									},
									failure: function() {
										onXhrFailure.call(this, getThenLoad.call(this, 'indexes'));
									},
									upprogress: refreshProgressBar
								})
							}
						);
					},
					position: 'before',
					html: templator('button', {
						text: 'Nouveau',
						attrs: {
							name: 'add',
							type: 'button',
							class: 'btn-primary'
						}
					})
				},
				'open': {
					method: function(e) {
						const grid = this.grid;
						const entry = grid.getRowValues(grid.lastSelectedRowIndex);
						onegeoClient.action.get(entry.location, {
							successful: function(data) {
								modal_UpdateIndex(data, function(data, callback) {
									onegeoClient.action.put(entry.location, {
										data: data,
										successful: function(location) {
											console.log('Index updated: ' + location);
											typeof callback === 'function' && callback(data);
										},
										failure: function() {
											onXhrFailure.call(this, getThenLoad.call(this, 'indexes'));
										},
										upprogress: refreshProgressBar
									})
								});
							},
							failure : function() {
								onXhrFailure.call(this);
							}
						})
					},
					position: 'after',
					html: templator('button', {
						text: 'Configurer <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>',
						attrs: {
							name: 'open',
							type: 'button'
						}
					})
				},
				'remove': {
					method: function(e) {
						e.preventDefault();
						e.stopPropagation();
						const grid = this.grid;
						const entry = grid.getRowValues(grid.lastSelectedRowIndex);
						modal_Delete(entry.name, function(callback) {
							onegeoClient.action.delete(entry.location, {
								successful: function() {
									console.log('Index deleted: ' + entry.location);
									typeof callback === 'function' && callback(entry.location);
								},
								failure: function() {
									onXhrFailure.call(this, getThenLoad.call(this, 'indexes'));
								}
							})
						});
					},
					position: 'after',
					html: templator('button', {
						text: 'Supprimer <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>',
						attrs: {
							name: 'remove',
							type: 'button',
							class: 'btn-danger'
						}
					})
				}
			}),

			// Tableau des profils de recherche :
			'services': new Table('table-services', 'Services', [{
				name: 'name',
				label: 'Nom',
				editable: false,
				datatype: 'string'
			}, {
				name: 'indexes',
				label: 'Index',
				editable: false,
				datatype: 'string'
			}, {
				name: 'location',
				label: '_HIDDEN',
				editable: false,
				datatype: 'string'
			}], {
				'add': {
					method: function(e) {
						e.preventDefault();
						e.stopPropagation();
						const grid = this.grid;
						modal_CreateService(
							function(callback) {
								onegeoClient.action.get('/indexes', {
									successful: function(data) {
										typeof callback === 'function' && callback(data);
									},
									failure: function() {
										onXhrFailure.call(this);
									}
								})
							},
							function(data) {
								onegeoClient.action.post('/services', {
									data: data,
									successful: function(location) {
										console.log('New index created: ' + location);
									},
									failure: function() {
										onXhrFailure.call(this, getThenLoad.call(this, 'services'));
									},
									upprogress: refreshProgressBar
								})
							}
						);
					},
					position: 'before',
					html: templator('button', {
						text: 'Nouveau',
						attrs: {
							name: 'add',
							type: 'button',
							class: 'btn-primary'
						}
					})
				},
				'update': {
					method: function(e) {
						e.preventDefault();
						e.stopPropagation();
						const grid = this.grid;
						const entry = grid.getRowValues(grid.lastSelectedRowIndex);
						onegeoClient.action.get(entry.location, {
							successful: function(data) {
								onegeoClient.action.get('/indexes', {
									successful: function(indexes) {
										modal_UpdateService(data, indexes, function(data, callback) {
											onegeoClient.action.put(entry.location, {
												data: data,
												successful: function() {
													console.log('Service updated: ' + entry.location);
													typeof callback === 'function' && callback(data);
												},
												failure: function() {
													onXhrFailure.call(this, getThenLoad.call(this, 'services'));
												},
												upprogress: refreshProgressBar
											})
										});
									},
									failure: function() {
										onXhrFailure.call(this);
									}
								});
							},
							failure: function() {
								onXhrFailure.call(this);
							}
						});
					},
					position: 'after',
					html: templator('button', {
						text: 'Configurer <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>',
						attrs: {
							name: 'update',
							type: 'button'
						}
					})
				},
				'remove': {
					method: function(e) {
						e.preventDefault();
						e.stopPropagation();
						const grid = this.grid;
						const entry = grid.getRowValues(grid.lastSelectedRowIndex);
						modal_Delete(entry.name, function(callback) {
							onegeoClient.action.delete(entry.location, {
								successful: function() {
									console.log('Service deleted: ' + entry.location);
									typeof callback === 'function' && callback(entry.location);
								},
								failure: function() {
									onXhrFailure.call(this, getThenLoad.call(this, 'services'));
								}
							})
						});
					},
					position: 'after',
					html: templator('button', {
						text: 'Supprimer <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>',
						attrs: {
							name: 'remove',
							type: 'button',
							class: 'btn-danger'
						}
					})
				}
			}),

			// Tableau des paramètres de Query-String :
			'qs-params': new Table('table-qs-params', 'QS-Params', [{
				name: 'key',
				label: 'Paramètre',
				editable: false,
				datatype: 'string'
			}, {
				name: 'description',
				label: 'Description',
				editable: false,
				datatype: 'string'
			}, {
				name: 'type',
				label: 'Type',
				editable: false,
				datatype: 'string'
			}]),

			// Dashboard pour le suivi des taches
			// Tableau des ressources :
			'tasks': new Table('table-tasks', 'Tasks', [{
				id: 'id',
				label: 'id',
				editable: false,
				datatype: 'string'
			}, {
				name: 'status',
				label: 'status',
				editable: false,
				datatype: 'string'
			}, {
				name: 'location',
				label: 'location',
				editable: false,
				datatype: 'object'
			}])
		};

		$('#sign_in')
			.click(function() {
				if (onegeoClient.logged) {
					modal_SignOut(function() {
						window.location.reload();  // C'est moche !
					});
				} else {
					modal_SignIn(function() {/* Rien à faire */});
				};
			});

		const loadTable = function(tabName, data) {
			$('.tab-pane#' + tabName).html(templator('table_grid', {name: tabName}));
			return table[tabName].update(data);
		};

		const parseData = function(data, attrs) {
			const arr = [];
			for (let i = 0; i < data.length; i ++) {
				const values = [];
				for (const attr of attrs) {
					let str = 'data[i]';
					for (const k of attr.split('.')) {
						str += "['" + k + "']";
					};
					values.push(eval(str));
				};
				arr.push({id: i, values: values});
			};
			return arr;
		};

		const HASH_TAB = [];

		$('a[data-toggle="tab"]')
			.each(function(e) {
				HASH_TAB.push($(this).prop('hash'));
			})
			.on('show.bs.tab', function(e) {
				const hash = $(e.target).prop('hash');
				window.location = hash;
			})
			.on('shown.bs.tab', function(e) {/* Rien à faire */});


		$('a[data-toggle="tab"]:not([href="' + HASH_TAB[0] + '"])').each(function(e) {
			$(this).click(function(e) {
				const that = this;
				if (HASH_TAB.indexOf(this.hash) > -1) {
					getThenLoad(this.hash.substring(1), {
						data: {'include': this.hash.substring(1) == 'sources' ? false : true},
						failure: function() {
							e.stopPropagation();
							onXhrFailure.call(this, function() {
								$(that).trigger('click');  // == $(this).click.call($(this));
							});
						},
						downprogress: refreshProgressBar
					})();
				} else {
					e.stopPropagation();
				};
			});
		});

		$(window).bind('hashchange', function(e) {
			const hash = window.location.hash;
			HASH_TAB.indexOf(hash) > -1 && $('a[href="' + hash + '"]').tab('show');
		});

		$(window).bind('statechange', function(e) {
			console.log('state is changing')
		});

		$('#site_brand').text('Onegeo');
		$('head>title').text('Onegeo');
		$('#site_title').text(settings.title);
		$('[name="current-year"]').text((new Date()).getFullYear());

		const goHome = function() {
			$('a[href="' + HASH_TAB[0] + '"]').tab('show');
		};

		goHome();

	});
});
	</script>
</html>
