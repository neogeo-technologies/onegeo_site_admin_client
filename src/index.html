<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
		<script>;window.isMobile=(function(a){if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))){return true;}else{return false;};})(navigator.userAgent||navigator.vendor||window.opera);</script>
		<script src="assets/libs/jquery/dist/jquery.min.js"></script>
		<script src="assets/libs/moment/min/moment-with-locales.min.js"></script>
		<script src="assets/libs/bootstrap/dist/js/bootstrap.min.js"></script>
		<script src="assets/libs/editablegrid/editablegrid.js"></script>
		<script src="assets/libs/editablegrid/editablegrid_renderers.js"></script>
		<script src="assets/libs/editablegrid/editablegrid_editors.js"></script>
		<script src="assets/libs/editablegrid/editablegrid_validators.js"></script>
		<script src="assets/libs/editablegrid/editablegrid_utils.js"></script>
		<script src="assets/libs/editablegrid/editablegrid_charts.js"></script>
		<script src="assets/js/editablegrid_overloaded.js"></script>
		<script src="assets/js/editablegrid_utils.js"></script>
		<script src="assets/js/onegeo_client.js"></script>
		<script>
		(function() {
			const cache = {};
			this.templator = function _templator(str, data) {
				// Figure out if we're getting a template, or if we need to
				// load the template - and be sure to cache the result.
				const fn = !/\W/.test(str) ?
					cache[str] = cache[str] || _templator(document.getElementById(str).innerHTML) :
					new Function('obj',
						"const _p = [];" +
						"const print = function() {" +
						"    _p.push.apply(_p, arguments);" +
						"};" +
						"with (obj) {" +
						"    _p.push('" +
							str
								.replace(/[\r\t\n]/g, ' ')
								.split('{%').join('\t')
								.replace(/((^|%})[^\t]*)'/g, '$1\r')
								.replace(/\t=(.*?)%}/g, "',$1,'")
								.split('\t').join("');")
								.split('%}').join("_p.push('")
								.split('\r').join("\\'") + "');" +
						"}" +
						"return _p.join('');");

				return data ? fn(data) : fn;
			};
		})();
		</script>
		<link rel="stylesheet" href="assets/libs/bootstrap/dist/css/bootstrap.min.css"/>
		<link rel="stylesheet" href="assets/libs/editablegrid/editablegrid.css"/>
		<link rel="stylesheet" href="assets/styles/default.css"/>
	</head>

	<!-- Sub-template -->
	<template id="sub_template">
		{% for (const entry of elements) { %}
			{%= templator(entry.template, entry.data) %}
		{% }; %}
	</template>

	<!-- Template d'un élément "button" -->
	<template id="button">
		<button type="{%= attrs.type %}" name="{%= attrs.name %}" class="btn {%= attrs.class || 'btn-default' %}">{%= text %}</button>
	</template>

	<!-- Template d'un élément "input" -->
	<template id="form_input">
		<div class="form-group">
			{% if (attrs.label) { %}
			<label for="{%='id_' + attrs.name %}">{%=attrs.label%}</label>
			{% }; %}
			<input id="{%='id_' + attrs.name %}" name="{%= attrs.name %}" list="{%= attrs.datalist ? attrs.name : '' %}" type="{%= attrs.type %}" pattern="{%= attrs.pattern || '.*' %}" class="form-control" placeholder="{%= attrs.placeholder || '' %}" autocomplete="{%= attrs.autocomplete || 'on' %}"/>
			{% if (attrs.datalist) { %}
			<datalist id="{%= attrs.name %}">
				{% for (const value of attrs.datalist.options) { %}
				<option value="{%= value %}">{%= value %}</option>
				{% }; %}
			</datalist>
			{% }; %}
		</div>
	</template>

	<!-- Template d'un élément "select" -->
	<template id="form_select">
		<div class="form-group">
			{% if (attrs.label) { %}
			<label for="{%='id_' + attrs.name %}">{%=attrs.label%}</label>
			{% }; %}
			<select id="{%='id_' + attrs.name %}" name="{%= attrs.name %}" class="form-control">
			{% for (const value of options) { %}
				<option value="{%= value %}">{%= value %}</option>
			{% }; %}
			</select>
		</div>
	</template>

	<!-- Template d'un élément "multiselect" -->
	<!-- TODO Faire un multiselect cool -->
	<template id="form_multiselect">
		<div class="form-group">
			{% if (attrs.label) { %}
			<label for="{%='id_' + attrs.name %}">{%=attrs.label%}</label>
			{% }; %}
			<select multiple id="{%='id_' + attrs.name %}" name="{%= attrs.name %}" class="form-control">
			{% for (const value of options) { %}
				<option value="{%= value %}">{%= value %}</option>
			{% }; %}
			</select>
		</div>
	</template>

	<!-- Template d'un élément "p" -->
	<template id="paragraph">
		<p>{%= text %}</p>
	</template>

	<!-- Template d'un élément "span" -->
	<template id="span">
		<span class="{%= attrs.class || '' %}">{%= text %}</span>
	</template>

	<!-- Template de la fenêtre "modal" -->
	<template id="modal">
		<div class="modal fade" tabindex="-1" role="dialog">
			<div class="modal-dialog {%= dialog.class || '' %}" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" name="close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
						<h4 class="modal-title">{%= heading.title.text %}</h4>
					</div>
					<form onsubmit="{%=body.onsubmit || 'return false;' %}">
						<div class="modal-body">
							{% for (const entry of body.elements) { %}
								{%= templator(entry.template, entry.data) %}
							{% }; %}
						</div>
						<div class="modal-footer">
							{% for (const entry of footer.elements) { %}
								{%= templator(entry.template, entry.data) %}
							{% }; %}
						</div>
					</form>
				</div>
			</div>
		</div>
	</template>

	<!-- Template de la fenêtre "carousel" -->
	<template id="carousel">
		<div id="{%= 'id_' + name %}" name="{%= name %}" class="carousel slide" data-ride="carousel">
			<div class="carousel-inner" role="listbox">
			{% for (let i in slides) { %}
				<div class="{%= i == 0 ? 'item active' : 'item' %}">
					{%= templator(slides[i].template, slides[i].data) %}
				</div>
			{% }; %}
			</div>
		</div>
	</template>

	<!-- Template du tableau "editablegrid" -->
	<template id="table_grid">
		<div id="table-{%= name %}" class="table-responsive"></div>
		<nav aria-label="Page navigation" style="text-align: center;">
			<ul id="table-{%= name %}-paginator" class="pagination pagination-sm"></ul>
		</nav>
	</template>

	<!-- Corps de la page -->
	<body>
		<div class="page-header">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<span id="site_title" class="title"></span>
						<span name="identity" class="identity"></span>
						<div class="btn-group login">
							<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
								<span class="glyphicon glyphicon-user"></span>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="menu-container">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<ul id="menu" class="nav nav-tabs" role="tablist">
							<li role="presentation">
								<a href="#home" aria-controls="home" role="tab" data-toggle="tab"><span class="glyphicon glyphicon-home"></span></a>
							</li>
							<li role="presentation">
								<a href="#sources" aria-controls="sources" role="tab" data-toggle="tab">Sources de données</a>
							</li>
							<li role="presentation">
								<a href="#indexes" aria-controls="indexes" role="tab" data-toggle="tab">Profils d'indexation</a>
							</li>
							<li role="presentation">
								<a href="#services" aria-controls="services" role="tab" data-toggle="tab">Profils de recherche</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
		<div class="main-container">
			<div class="container">
				<div class="row">
					<div class="col-md-12">
						<div class="tab-content">
							<div id="home" role="tabpanel" class="tab-pane fade in">
								<span>Page d'accueil</span>
							</div>
							<div id="sources" role="tabpanel" class="tab-pane fade in"></div>
							<div id="indexes" role="tabpanel" class="tab-pane fade in"></div>
							<div id="services" role="tabpanel" class="tab-pane fade in"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div class="footer navbar-fixed-bottom">
			<div class="container">
				<div class="row">
					<div class="col-md-12" style="text-align: center;">
						<p>© 2017 <a href='http://www.neogeo.fr' target="blank">Neogeo-Technologies</p>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script>
$(function() {return (function(cb) {
	const xhr = new XMLHttpRequest();
	xhr.overrideMimeType('application/json');
	xhr.open('GET', 'config/settings.json', true);
	xhr.onreadystatechange = function() {
		if (xhr.readyState == 4 && xhr.status == '200') {
			cb(JSON.parse(xhr.responseText));
		};
	};
	xhr.send(null);
})(function(settings) {

	$('#site_title').text(settings.title || 'Site de gestion de services de recherches Onegeo')
	const baseApiUrl = (settings.url || window.location.origin) + settings.path;
	const onegeoClient = new OnegeoClient(baseApiUrl);

	const onXhrFailure = function(cb) {
		if (this.status === 401) {
			openModalSignIn(cb);
		} else {
			// TODO
			alert(this.status + ' - ' + this.statusText);
		};
	};

	const disabledButton = function($button) {
		$button.addClass('disabled').prop('disabled', true);
	};

	const enabledButton = function($button) {
		$button.removeClass('disabled').prop('disabled', false);
	};

	const getModal = function() {
		return $('.modal')
			.modal({
				'backdrop': 'static',
				'show': false
			})
			.on('hidden.bs.modal', function() {
				$(this).remove();
			});
	};

	const getCarousel = function() {
		return $('.carousel')
			.carousel({
				interval: false,
				wrap: false,
				keyword: false
			});
	};

	const openModalSignIn = function(callback) {

		// Construit la fenêtre "modal"..
		$('body').prepend(templator('modal', {
			dialog: {
				class: 'modal-sm'
			},
			heading: {
				title: {
					text: 'Connectez-vous'
				}
			},
			body: {
				elements: [{
					template: 'form_input',
					data: {
						attrs: {
							name: 'username',
							type: 'text',
							placeholder: 'Utilisateur'
						}
					}
				}, {
					template: 'form_input',
					data: {
						attrs: {
							name: 'password',
							type: 'password',
							placeholder: 'Mot de passe'
						}
					}
				}]
			},
			footer: {
				elements: [{
					template: 'button',
					data: {
						text: 'Se connecter',
						attrs: {
							name: 'submit',
							type: 'submit'
						}
					}
				}]
			}
		}));

		const $modal = getModal();

		// Définit les actions..
		$modal.find('button[name="submit"]').click(function(e) {
			const $username = $modal.find('input[name=username]');
			const $password = $modal.find('input[name=password]');
			if ($username.val() && $password.val()) {
				onegeoClient.connect($username.val(), $password.val(), function(isLogged) {
					if (isLogged) {
						$('[name="identity"]').text($username.val());
						$modal.modal('hide');
						typeof callback === 'function' && callback();
					} else {
						$password.val('');
						$username.val('').focus();
					};
				});
			} else {
				!$username.val() ? $username.focus() : $password.focus();
			};
		});
		$modal.find('button[name="close"]').click(function(e) {
			$('a[href="' + HASH_TAB[0] + '"]').tab('show');
		});

		// Puis ouvre la fenêtre "modal"..
		$modal.modal('show');
	};


	const openModalSignOut = function(callback) {

		// Construit la fenêtre "modal"..
		$('body').prepend(templator('modal', {
			dialog: {
				class: 'modal-sm'
			},
			heading: {
				title: {
					text: 'Fermer la session'
				}
			},
			body: {
				elements: [{
					template: 'paragraph',
					data: {
						text: 'Vous êtes sur le point de vous déconnecter.'
					}
				}]
			},
			footer: {
				elements: [{
					template: 'button',
					data: {
						text: 'Se déconnecter',
						attrs: {
							name: 'submit',
							type: 'button'
						}
					}
				}]
			}
		}));

		const $modal = getModal();

		// Définit les actions..
		$modal.find('button[name=submit]').click(function(e) {
			onegeoClient.disconnect(function() {
				$('[name="identity"]').empty();
				typeof callback === 'function' && callback();
			});
		});

		// Puis ouvre la fenêtre "modal"..
		$modal.modal('show');
	};


	/*
	Fenêtre « modal » pour l'ajout d'une source de données.

	*/
	const openModalAddSource = function(getURICallback, getProtocolCallback, postSourceCallback) {

		// Construit la fenêtre "modal"..
		$('body').prepend(templator('modal', {
			dialog: {},
			heading: {
				title: {
					text: 'Ajouter une nouvelle source de données'
				}
			},
			body: {
				elements: [{
					template: 'carousel',
					data: {
						name: 'source-form',
						slides: [{
							template: 'sub_template',
							data: {
								elements: [{
									template: 'span',
									data:{
										text: '<h3>Étape 1</h3>',
										attrs: {}
									}
								}, {
									template: 'form_input',
									data: {
										attrs: {
											name: 'name',
											type: 'text',
											placeholder: '[a-z0-9_]{3,100}',
											label: 'Nom de la source de données',
											pattern: '[a-z0-9_]{3,100}',
											autocomplete: 'off'
										}
									}
								}]
							}
						}, {
							template: 'sub_template',
							data: {
								elements: [{
									template: 'span',
									data:{
										text: '<h3>Étape 2</h3>',
										attrs: {}
									}
								}, {
									template: 'form_input',
									data: {
										attrs: {
											name: 'uri',
											type: 'text',
											placeholder: 'Sélectionnez ou indiquez une valeur',
											label: 'Indiquez l\'URI de la source de données',
											autocomplete: 'off',
											datalist: {
												options: []
											}
										}
									}
								}]
							}
						}, {
							template: 'sub_template',
							data: {
								elements: [{
									template: 'span',
									data:{
										text: '<h3>Étape 3</h3>',
										attrs: {}
									}
								}, {
									template: 'form_select',
									data: {
										attrs: {
											name: 'protocol',
											type: 'text',
											label: 'Sélectionnez le protocole de connexion à la source de données',
										},
										options: [] // Vide par défaut
									}
								}]
							}
						}]
					}
				}]
			},
			footer: {
				elements: [{
					template: 'button',
					data: {
						text: 'Étape suivante',
						attrs: {
							name: 'next',
							type: 'button'
						}
					}
				}, {
					template: 'button',
					data: {
						text: 'Créer',
						attrs: {
							name: 'submit',
							type: 'submit',
							class: 'btn-primary'
						}
					}
				}]
			}
		}));

		const $modal = getModal();
		const $carousel = getCarousel();

		// Définit les actions..
		const $name = $modal.find('input[name=name]').on('input', function() {
			let m;
			const regex = /^[a-z0-9_]{3,100}$/g;
			((m = regex.exec($(this).val())) !== null) ? enabledButton($next) : disabledButton($next);
		});

		const $uri = $modal.find('input[name=uri]').on('input', function() {
			$(this).val().length > 0 ? enabledButton($next) : disabledButton($next);
		})

		const $protocol = $modal.find('select[name=protocol]').on('change', function(e) {
			enabledButton($submit);
		});

		$modal.find('button[name=submit]').click(function(e) {
			typeof postSourceCallback === 'function' && postSourceCallback({
				name: $name.val(),
				uri: $uri.val(),
				mode: $protocol.val() // Deprecated
			});
		});

		const $next = $modal.find('button[name=next]').click(function(e) {
			e.stopPropagation();
			$carousel.on('slide.bs.carousel', function(e) {
				disabledButton($next);
				const i = $carousel.find('.active').index() + 1;
				if (i === 1) {
					typeof getURICallback === 'function' && getURICallback(function(data) {
						const $datalist = $uri.siblings('datalist#' + $uri.attr('name')).empty();
						for (const entry of data) {
							$datalist.append($('<option>', {
								value: entry,
								text: entry
							}));
						};
					});
				};
				if (i === 2) {
					$next.hide();
					$submit.show();
					typeof getProtocolCallback === 'function' && getProtocolCallback(function(data) {
						$protocol.empty().append($('<option>', {
							value: null,
							text: 'Choisissez un protocole',
							disabled: true,
							selected: true
						}));
						for (const key in data) {
							$protocol.append($('<option>', {
								value: key,
								text: data[key]
							}));
						};
					});
				}
			}).carousel(this.name);
		});

		const $submit = $modal.find('button[name=submit]').hide().click(function(e) {
			typeof callback === 'function' && callback({
				// TODO
			});
		});

		disabledButton($next);
		disabledButton($submit);

		// Puis ouvre la fenêtre "modal"..
		$modal.modal('show');
	};


	/*
	Fenêtre « modal » pour la suppression d'une source de données.

	*/
	const openModalRemoveGeneric = function(value, deleteCallback) {

		// Construit la fenêtre "modal"..
		$('body').prepend(templator('modal', {
			dialog: {},
			heading: {
				title: {
					text: 'Êtes-vous absolument sûr ?'
				}
			},
			body: {
				elements: [{
					template: 'paragraph',
					data: {
						text: 'Cette action est irreversible et supprimera définitivement la « chose ».'
					}
				}, {
					template: 'paragraph',
					data: {
						text: 'Pour confirmer, veuillez réécrire le nom de la « chose » à supprimer.'
					}
				}, {
					template: 'form_input',
					data: {
						attrs: {
							name: 'name',
							type: 'text',
							placeholder: 'Nom de la « chose » à supprimer',
							autocomplete: 'off'
						}
					}
				}]
			},
			footer: {
				elements: [{
					template: 'button',
					data: {
						text: 'Oui, supprimer définitivement la « chose »',
						attrs: {
							name: 'submit',
							type: 'submit',
							class: 'btn-danger btn-block'
						}
					}
				}]
			}
		}));

		const $modal = getModal();
		const $button = $modal.find('button[name=submit]').addClass('disabled').prop('disabled', true);

		const $name = $modal.find('input[name=name]').on('input', function(e) {
			// e.preventDefault();
			if ($(this).val() === value) {
				$button.removeClass('disabled').prop('disabled', false);
			} else {
				$button.addClass('disabled').prop('disabled', true);
			};
		});

		// Définit les actions..
		$modal.find('button[name=submit]').click(function(e) {
			if ($name.val() === value) {
				typeof deleteCallback === 'function' && deleteCallback();
			};
		});

		// Puis ouvre la fenêtre "modal"..
		$modal.modal('show');
	};


	/*
	Fenêtre « modal » pour la prévisualisation d'une source de données

	*/
	const openModalOpenSource = function(sourceName, data) {

		// Construit la fenêtre "modal"..
		$('body').prepend(templator('modal', {
			dialog: {
				class: 'modal-lg'
			},
			heading: {
				title: {
					text: 'Source de données : <strong>' + sourceName + '</strong>'
				}
			},
			body: {
				elements: [{
					template: 'paragraph',
					data: {
						text: "Ressource(s) disponible(s)"
					}
				}, {
					template: 'table_grid',
					data: {
						name: 'resources'
					}
				}]
			},
			footer: {
				elements: [{
					template: 'button',
					data: {
						text: 'Fermer',
						attrs: {
							name: 'close',
							type: 'submit'
						}
					}
				}]
			}
		}));

		const arr = [];
		for (let i = 0; i < data.length; i ++) {
			arr.push({
				id: i,
				values: [
					data[i].location,
					data[i].name,
					data[i].columns
				]
			});
		};
		table['resources'].update(arr);

		const $modal = getModal();

		// Définit les actions..
		$('button[name="close"]').click(function(e) {
			$modal.modal('hide');
			e.stopPropagation();
		});

		// Puis ouvre la fenêtre "modal"..
		$modal.modal('show');
	};


	/*
	Fenêtre « modal » pour la visualisation d'une resource de données.

	*/
	const openModalOpenColumns = function(resourceName, data, callback) {

		// Construit la fenêtre "modal"..
		$('body').prepend(templator('modal', {
			dialog: {
				class: 'modal-lg'
			},
			heading: {
				title: {
					text: 'Ressource de données : <strong>' + resourceName + '</strong>'
				}
			},
			body: {
				elements: [{
					template: 'paragraph',
					data: {
						text: 'Structure de la ressource de données'
					}
				}, {
					template: 'table_grid',
					data: {
						name: 'columns'
					}
				}]
			},
			footer: {
				elements: [{
					template: 'button',
					data: {
						text: 'Revenir',
						attrs: {
							name: 'previous',
							type: 'button'
						}
					}
				}, {
					template: 'button',
					data: {
						text: 'Fermer',
						attrs: {
							name: 'close',
							type: 'button'
						}
					}
				}]
			}
		}));

		const arr = [];
		for (let i = 0; i < data.length; i ++) {
			arr.push({
				id: i,
				values: [
					data[i].name,
					data[i].type || 'N/A',
					data[i].occurs ? '[' + data[i].occurs[0] + ', ' + data[i].occurs[1] + ']' : 'N/A'
				]
			});
		};
		table['columns'].update(arr);

		const $modal = getModal();

		// Définit les actions..
		$('button[name=previous]').click(function(e) {
			e.stopPropagation();
			typeof callback === 'function' && callback.call($modal);
		});

		$('button[name="close"]').click(function(e) {
			e.stopPropagation();
			$modal.modal('hide');
		});

		// Puis ouvre la fenêtre "modal"..
		$modal.modal('show');
	};


	/*
	Fenêtre « modal » pour la création d'un modèle d'indexation.

	*/
	const openModalAddIndex = function(getSourcesCallback, getResourceCallback, postIndexCallback) {

		$('body').prepend(templator('modal', {
			dialog: {
				class: 'modal-md'
			},
			heading: {
				title: {
					text: 'Créer un nouvel index de données'
				}
			},
			body: {
				elements: [{
					template: 'carousel',
					data: {
						name: 'index-form',
						slides: [{
							template: 'sub_template',
							data: {
								elements: [{
									template: 'span',
									data:{
										text: '<h3>Étape 1</h3>',
										attrs: {}
									}
								}, {
									template: 'form_input',
									data: {
										attrs: {
											name: 'name',
											type: 'text',
											placeholder: '[a-z0-9_]{3,100}',
											label: 'Indiquez un nom pour ce nouvel index de données',
											pattern: '[a-z0-9_]{3,100}',
											autocomplete: 'off'
										}
									}
								}]
							}
						}, {
							template: 'sub_template',
							data: {
								elements: [{
									template: 'span',
									data:{
										text: '<h3>Étape 2</h3>',
										attrs: {}
									}
								}, {
									template: 'form_select',
									data: {
										attrs: {
											name: 'source',
											type: 'text',
											label: 'Sélectionnez la source de données'
										},
										options: []
									}
								}, {
									template: 'paragraph',
									data:{
										text: 'Si la source de données n\'est pas dans la liste, vous pouvez l\'<a href="#source">ajouter ici</a>'
									}
								}]
							}
						}, {
							template: 'sub_template',
							data: {
								elements: [{
									template: 'span',
									data:{
										text: '<h3>Étape 3</h3>',
										attrs: {}
									}
								}, {
									template: 'form_select',
									data: {
										attrs: {
											name: 'resource',
											type: 'text',
											label: 'Sélectionnez la resource de données'
										},
										options: [] // Vide par défaut
									}
								}]
							}
						}]
					}
				}]
			},
			footer: {
				elements: [{
					template: 'button',
					data: {
						text: 'Étape suivante',
						attrs: {
							name: 'next',
							type: 'button'
						}
					}
				}, {
					template: 'button',
					data: {
						text: 'Créer',
						attrs: {
							name: 'submit',
							type: 'submit',
							class: 'btn-primary'
						}
					}
				}]
			}
		}));

		const $modal = getModal();
		const $carousel = getCarousel();

		// Définit les actions..
		const $name = $modal.find('input[name=name]').on('input', function() {
			let m;
			const regex = /^[a-z0-9_]{3,100}$/g;
			((m = regex.exec($(this).val())) !== null) ? enabledButton($next) : disabledButton($next);
		});

		const $source = $modal.find('select[name=source]').on('change', function(e) {
			enabledButton($next);
		});

		const $resource = $modal.find('select[name=resource]').on('change', function(e) {
			enabledButton($submit);
		});

		const $next = $modal.find('button[name=next]').click(function(e) {
			e.stopPropagation();
			$carousel.on('slide.bs.carousel', function(e) {
				disabledButton($next);
				const i = $carousel.find('.active').index() + 1;
				if (i === 1) {
					typeof getSourcesCallback === 'function' && getSourcesCallback(function(data) {
						$source.empty().append($('<option>', {
							value: null,
							text: 'Choisissez une source de données',
							disabled: true,
							selected: true
						}));
						for (const entry of data) {
							$source.append($('<option>', {
								value: entry.location,
								text: entry.name
							}));
						};
					});
				};
				if (i === 2 && $source.val()) {
					$next.hide();
					$submit.show();
					typeof getSourcesCallback === 'function' && getResourceCallback($source.val() + '/resources', function(data) {
						$resource.empty().append($('<option>', {
							value: null,
							text: 'Choisissez une resource',
							disabled: true,
							selected: true
						}));
						for (const entry of data) {
							$resource.append($('<option>', {
								value: entry.location,
								text: entry.name
							}));
						};
					});
				}
			}).carousel(this.name);
		});

		const $submit = $modal.find('button[name=submit]').hide().click(function(e) {
			typeof postIndexCallback === 'function' && postIndexCallback({
				name: $name.val(),
				resource: $resource.val()
			}, function(location) {
				$modal.modal('hide').on('hidden.bs.modal', function(location) {
					getIndexes('indexes');
				});
			});
		});

		disabledButton($next);
		disabledButton($submit);

		// Puis ouvre la fenêtre "modal"..
		$modal.modal('show');
	};


	/*
	Fenêtre « modal » pour la création d'un modèle de recherche.

	*/
	const openModalAddService = function(getIndexesCallback, postServiceCallback) {

		// Construit la fenêtre "modal"..
		$('body').prepend(templator('modal', {
			dialog: {
				class: 'modal-md'
			},
			heading: {
				title: {
					text: 'Créer un nouveau service de recherche'
				}
			},
			body: {
				elements: [{
					template: 'carousel',
					data: {
						name: 'index-form',
						slides: [{
							template: 'sub_template',
							data: {
								elements: [{
									template: 'span',
									data:{
										text: '<h3>Étape 1</h3>',
										attrs: {}
									}
								}, {
									template: 'form_input',
									data: {
										attrs: {
											name: 'name',
											type: 'text',
											placeholder: '[a-z0-9_]{3,100}',
											label: 'Indiquez un nom pour ce nouveau service de recherche',
											pattern: '[a-z0-9_]{3,100}',
											autocomplete: 'off'
										}
									}
								}]
							}
						}, {
							template: 'sub_template',
							data: {
								elements: [{
									template: 'span',
									data:{
										text: '<h3>Étape 2</h3>',
										attrs: {}
									}
								}, {
									template: 'paragraph',
									data:{
										text: 'Un service de recherche doit pointer sur au moins un profil d\'indexation.'
									}
								}, {
									template: 'form_multiselect',
									data: {
										attrs: {
											name: 'indexes',
											type: 'text',
											label: 'Choisissez les profils d\'indexation à rattacher',
										},
										options: [] // Vide par défaut
									}
								}, {
									template: 'paragraph',
									data:{
										text: 'Ou bien valider directement la création du profil, vous avez la toujours possiblité de le configurer plus tard.'
									}
								}]
							}
						}]
					}
				}]
			},
			footer: {
				elements: [{
					template: 'button',
					data: {
						text: 'Étape suivante',
						attrs: {
							name: 'next',
							type: 'button'
						}
					}
				}, {
					template: 'button',
					data: {
						text: 'Créer',
						attrs: {
							name: 'submit',
							type: 'submit',
							class: 'btn-default'
						}
					}
				}]
			}
		}));

		const $modal = getModal();
		const $carousel = getCarousel();

		// Définit les actions..
		const $name = $modal.find('input[name=name]').on('input', function() {
			let m;
			const regex = /^[a-z0-9_]{3,100}$/g;
			((m = regex.exec($(this).val())) !== null) ? enabledButton($next) : disabledButton($next);
		});

		const $indexes = $modal.find('select[name=indexes]').on('change', function(e) {
			// enabledButton($submit);
		});

		const $next = $modal.find('button[name=next]').click(function(e) {
			e.stopPropagation();
			$carousel.on('slide.bs.carousel', function(e) {
				disabledButton($next);
				const i = $carousel.find('.active').index() + 1;
				if (i === 1) {
					$next.hide();
					$submit.show();
					enabledButton($submit);
					typeof getIndexesCallback === 'function' && getIndexesCallback(function(data) {
						$indexes.empty();
						for (const entry of data) {
							$indexes.append($('<option>', {
								value: entry.location,
								text: entry.name
							}));
						};
					});
				};
			}).carousel(this.name);
		});

		const $submit = $modal.find('button[name=submit]').hide().click(function(e) {
			typeof postServiceCallback === 'function' && postServiceCallback({
				name: $name.val(),
				indexes: $indexes.val()
			});
		});

		disabledButton($next);
		disabledButton($submit);

		// Puis ouvre la fenêtre "modal"..
		$modal.modal('show');
	};


	// Définition des tableaux :
	const table = {

		// Tableau des sources de données :
		'sources': new Table('table-sources', 'Sources', [{
			name: 'location',
			label: 'location',
			editable: false,
			datatype: 'string'
		}, {
			name: 'name',
			label: 'name',
			editable: false,
			datatype: 'string'
		}, {
			name: 'protocol',
			label: 'protocol',
			editable: false,
			datatype: 'string'
		}, {
			name: 'uri',
			label: 'uri',
			editable: false,
			datatype: 'url'
		}], {
			'add': {
				method: function(e) {
					e.preventDefault();
					e.stopPropagation();
					const grid = this.grid;
					openModalAddSource(
						function(callback) {
							onegeoClient.action.get('/sources_directories', {
								successful: function(data) {
									typeof callback === 'function' && callback(data);
								},
								failure: function() {
									onXhrFailure.call(this);
								}
							})
						},
						function(callback) {
							onegeoClient.action.get('/supported_modes', {
								successful: function(data) {
									typeof callback === 'function' && callback(data);
								},
								failure: function() {
									onXhrFailure.call(this);
								}
							})
						},
						function(data) {
							onegeoClient.action.post('/sources', {
								data: data,
								successful: function(location) {
									console.log('New source created: ' + location);
								},
								failure: function() {
									onXhrFailure.call(this);
								}
							})
						}
					);
				},
				position: 'before',
				html: templator('button', {
					text: 'Nouveau',
					attrs: {
						name: 'add',
						type: 'button',
						class: 'btn-primary'
					}
				})
			},
			'open': {
				method: function(e) {
					e.preventDefault();
					e.stopPropagation();
					const grid = this.grid;
					const entry = grid.getRowValues(grid.lastSelectedRowIndex);
					onegeoClient.action.get(entry.location + '/resources', {
						successful: function(data) {
							openModalOpenSource(entry.name, data);
						},
						failure: function() {
							onXhrFailure.call(this);
						}
					});
				},
				position: 'after',
				html: templator('button', {
					text: 'Voir les ressources <span class="glyphicon glyphicon glyphicon-eye-open" aria-hidden="true"></span>',
					attrs: {
						name: 'open',
						type: 'button'
					}
				})
			},
			'remove': {
				method: function(e) {
					e.preventDefault();
					e.stopPropagation();
					const grid = this.grid;
					const entry = grid.getRowValues(grid.lastSelectedRowIndex);
					openModalRemoveGeneric(entry.name, function(data) {
						onegeoClient.action.delete(entry.location, {
							successful: function() {
								console.log('Source deleted: ' + entry.location);
							},
							failure: function() {
								onXhrFailure.call(this);
							}
						})
					});
				},
				position: 'after',
				html: templator('button', {
					text: 'Supprimer <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>',
					attrs: {
						name: 'remove',
						type: 'button',
						class: 'btn-danger'
					}
				})
			}
		}),

		// Tableau des ressources :
		'resources': new Table('table-resources', 'Resources', [{
			name: 'location',
			label: 'location',
			editable: false,
			datatype: 'string'
		}, {
			name: 'name',
			label: 'name',
			editable: false,
			datatype: 'string'
		}, {
			name: 'columns',
			label: '_HIDDEN',
			editable: false,
			datatype: 'object'
		}], {
			'open': {
				method: function() {
					$('.modal').modal('hide').on('hidden.bs.modal', function() {
						const grid = this.grid;
						const entry = grid.getRowValues(grid.lastSelectedRowIndex);
						openModalOpenColumns(entry.name, entry.columns, function() {
							this.modal('hide').on('hidden.bs.modal', function() {
								// TODO
							})
						});
					}.bind(this));
				},
				position: 'after',
				html: templator('button', {
					text: 'Ouvrir',
					attrs: {
						name: 'open',
						type: 'button'
					}
				})
			}
		}),

		// Tableau des propriétés de données :
		'columns': new Table('table-columns', 'Columns', [{
			name: 'name',
			label: 'name',
			editable: false,
			datatype: 'string'
		}, {
			name: 'type',
			label: 'type',
			editable: false,
			datatype: 'string'
		}, {
			name: 'occurs',
			label: 'occurs',
			editable: false,
			datatype: 'string'
		}]),

		// Tableau des profils d'indexation :
		'indexes': new Table('table-indexes', 'Indexes', [{
			name: 'location',
			label: 'location',
			editable: false,
			datatype: 'string'
		}, {
			name: 'name',
			label: 'Nom',
			editable: false,
			datatype: 'string'
		}, {
			name: 'resource_location',
			label: 'resource_location',
			editable: false,
			datatype: 'string'
		}], {
			'add': {
				method: function(e) {
					e.preventDefault();
					e.stopPropagation();
					const grid = this.grid;
					openModalAddIndex(
						function(callback) {
							onegeoClient.action.get('/sources', {
								successful: function(data) {
									typeof callback === 'function' && callback(data);
								},
								failure: function() {
									onXhrFailure.call(this);
								}
							})
						},
						function(resourceLocation, callback) {
							onegeoClient.action.get(resourceLocation, {
								successful: function(data) {
									typeof callback === 'function' && callback(data);
								},
								failure: function() {
									onXhrFailure.call(this);
								}
							})
						},
						function(data, callback) {
							onegeoClient.action.post('/indexes', {
								data: data,
								successful: function(location) {
									console.log('New index created: ' + location);
									typeof callback === 'function' && callback(data);
								},
								failure: function() {
									onXhrFailure.call(this);
								}
							})
						}
					);
				},
				position: 'before',
				html: templator('button', {
					text: 'Nouveau',
					attrs: {
						name: 'add',
						type: 'button',
						class: 'btn-primary'
					}
				})
			},
			'open': {
				method: function() {
					const grid = this.grid;
				},
				position: 'after',
				html: templator('button', {
					text: 'Configurer <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>',
					attrs: {
						name: 'open',
						type: 'button'
					}
				})
			},
			'remove': {
				method: function(e) {
					e.preventDefault();
					e.stopPropagation();
					const grid = this.grid;
					const entry = grid.getRowValues(grid.lastSelectedRowIndex);
					openModalRemoveGeneric(entry.name, function(data) {
						onegeoClient.action.delete(entry.location, {
							successful: function() {
								console.log('Index deleted: ' + entry.location);
							},
							failure: function() {
								onXhrFailure.call(this);
							}
						})
					});
				},
				position: 'after',
				html: templator('button', {
					text: 'Supprimer <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>',
					attrs: {
						name: 'remove',
						type: 'button',
						class: 'btn-danger'
					}
				})
			}
		}),
		// Tableau des profils de recherche :
		'services': new Table('table-services', 'Services', [{
			name: 'location',
			label: 'location',
			editable: false,
			datatype: 'string'
		}, {
			name: 'name',
			label: 'Nom',
			editable: false,
			datatype: 'string'
		}, {
			name: 'service_url',
			label: 'URL du service',
			editable: false,
			datatype: 'url'
		}, {
			name: 'extended',
			label: 'Extension',
			editable: false,
			datatype: 'boolean'
		}], {
			'add': {
				method: function(e) {
					e.preventDefault();
					e.stopPropagation();
					const grid = this.grid;
					openModalAddService(
						function(callback) {
							onegeoClient.action.get('/indexes', {
								successful: function(data) {
									typeof callback === 'function' && callback(data);
								},
								failure: function() {
									onXhrFailure.call(this);
								}
							})
						},
						function(data) {
							onegeoClient.action.post('/services', {
								data: data,
								successful: function(location) {
									console.log('New index created: ' + location);
								},
								failure: function() {
									onXhrFailure.call(this);
								}
							})
						}
					);
				},
				position: 'before',
				html: templator('button', {
					text: 'Nouveau',
					attrs: {
						name: 'add',
						type: 'button',
						class: 'btn-primary'
					}
				})
			},
			'open': {
				method: function() {
					const grid = this.grid;
				},
				position: 'after',
				html: templator('button', {
					text: 'Configurer <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>',
					attrs: {
						name: 'open',
						type: 'button'
					}
				})
			},
			'remove': {
				method: function(e) {
					e.preventDefault();
					e.stopPropagation();
					const grid = this.grid;
					const entry = grid.getRowValues(grid.lastSelectedRowIndex);
					openModalRemoveGeneric(entry.name, function(data) {
						onegeoClient.action.delete(entry.location, {
							successful: function() {
								console.log('Service deleted: ' + entry.location);
							},
							failure: function() {
								onXhrFailure.call(this);
							}
						})
					});
				},
				position: 'after',
				html: templator('button', {
					text: 'Supprimer <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>',
					attrs: {
						name: 'remove',
						type: 'button',
						class: 'btn-danger'
					}
				})
			}
		})
	};


	$('.login button')
		.click(function() {
			if (onegeoClient.logged) {
				openModalSignOut(function() {
					window.location.reload();  // C'est moche !
				});
			} else {
				openModalSignIn(function() {/* Rien à faire */});
			};
		});

	// TODO: Déplacer vers onegeo_client.js
	const getSources = function(onSuccessCallback, onFailureCallback) {
		onegeoClient.action.get('/sources', {
			successful: onSuccessCallback,
			failure: onFailureCallback
		});
	};

	// TODO: Déplacer vers onegeo_client.js
	const getIndexes = function(onSuccessCallback, onFailureCallback) {
		onegeoClient.action.get('/indexes', {
			successful: onSuccessCallback,
			failure: onFailureCallback
		});
	};

	// TODO: Déplacer vers onegeo_client.js
	const getServices = function(onSuccessCallback, onFailureCallback) {
		onegeoClient.action.get('/services', {
			successful: onSuccessCallback,
			failure: onFailureCallback
		});
	};

	const loadTable = function(tabName, data) {
		$('.tab-pane#' + tabName).html(templator('table_grid', {name: tabName}));
		return table[tabName].update(data);
	};

	const parseData = function(data, attrs) {
		const arr = [];
		for (let i = 0; i < data.length; i ++) {
			const values = [];
			for (const attr of attrs) {
				values.push(data[i][attr]);
			};
			arr.push({id: i, values: values});
		};
		return arr;
	};

	const loadSources = function(e, tabName) {
		return function(data) {
			return loadTable(tabName, parseData(data, ['location', 'name', 'mode', 'uri']));
		};
	};

	const loadIndexes = function(e, tabName) {
		return function(data) {
			return loadTable(tabName, parseData(data, ['location', 'name', 'resource']));
		};
	};

	const loadServices = function(e, tabName) {
		return function(data) {
			return loadTable(tabName, parseData(data, ['location', 'name', 'service_url', 'extended']));
		};
	};


	const HASH_TAB = [];


	$('a[data-toggle="tab"]')
		.each(function(e) {
			HASH_TAB.push($(this).prop('hash'));
		})
		.on('show.bs.tab', function(e) {
			const hash = $(e.target).prop('hash');
			window.location = hash;
		})
		.on('shown.bs.tab', function(e) {/* Rien à faire */});


	$('a[data-toggle="tab"]:not([href="' + HASH_TAB[0] + '"])')
		.each(function(e) {
			$(this).click(function(e) {
				// e.preventDefault();

				const trigger = function() {
					$(this).trigger('click');  // $(this).click.call($(this));
				}.bind(this);

				const onFailure = function() {
					e.stopPropagation();
					onXhrFailure.call(this, trigger);
				};

				if (this.hash === '#sources') {
					getSources(loadSources.apply(this, [arguments, this.hash.substr(1)]), onFailure);
				} else if (this.hash === '#indexes') {
					getSources(function(data) {
						if (data.length > 0) {
							getIndexes(loadIndexes.apply(this, [arguments, this.hash.substr(1)]), onFailure);
						} else {
							$('body').prepend(templator('modal', {
								dialog: {
									class: 'modal-md'
								},
								heading: {
									title: {
										text: 'Information'
									}
								},
								body: {
									elements: [{
										template: 'paragraph',
										data: {
											text: 'Vous devriez commencer par ajouter une source de données.'
										}
									}]
								},
								footer: {
									elements: [{
										template: 'button',
										data: {
											text: 'Fermer',
											attrs: {
												name: 'close',
												type: 'button'
											}
										}
									}]
								}
							}));

							const $modal = getModal();

							$modal.find('button[name=close]').click(function(e) {
								$modal.on('hidden.bs.modal', function() {
									$('a[href="#sources"]').tab('show');
								}).modal('hide');
							});

							// Puis ouvre la fenêtre "modal"..
							$modal.modal('show');
						};
					}.bind(this), onFailure);
				} else if (this.hash === '#services') {
					getServices(loadServices.apply(this, [arguments, this.hash.substr(1)]), onFailure);
				} else {
					e.stopPropagation();
				};
			});
		});


	$('a[href="' + HASH_TAB[0] + '"]').tab('show');

});

});
	</script>
</html>
